<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="android,依赖注入,dagger2," />





  <link rel="alternate" href="/atom.xml" title="Metal626’s Notes" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="目录

HomeUser’s GuideAndroidMultibinding Sets and MapsSubcomponentsProducersTestingProject Pages  

到底部
HomeDagger是一个完全静态的编译时的Java和Android依赖注入矿建。它由Square发布的早期版本改造而来现在由Google维护。
Dagger致力于解决开发中使用基于反射的的解决">
<meta property="og:type" content="article">
<meta property="og:title" content="依赖注入框架Dagger2系统性学习">
<meta property="og:url" content="http://yoursite.com/2016/11/29/dagger2文档翻译/index.html">
<meta property="og:site_name" content="Metal626’s Notes">
<meta property="og:description" content="目录

HomeUser’s GuideAndroidMultibinding Sets and MapsSubcomponentsProducersTestingProject Pages  

到底部
HomeDagger是一个完全静态的编译时的Java和Android依赖注入矿建。它由Square发布的早期版本改造而来现在由Google维护。
Dagger致力于解决开发中使用基于反射的的解决">
<meta property="og:updated_time" content="2016-12-12T07:41:36.745Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="依赖注入框架Dagger2系统性学习">
<meta name="twitter:description" content="目录

HomeUser’s GuideAndroidMultibinding Sets and MapsSubcomponentsProducersTestingProject Pages  

到底部
HomeDagger是一个完全静态的编译时的Java和Android依赖注入矿建。它由Square发布的早期版本改造而来现在由Google维护。
Dagger致力于解决开发中使用基于反射的的解决">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2016/11/29/dagger2文档翻译/"/>





  <title> 依赖注入框架Dagger2系统性学习 | Metal626’s Notes </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?6f9256e19b7a628fa2646bc35feb03de";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Metal626’s Notes</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/29/dagger2文档翻译/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Metal626">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Metal626’s Notes">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Metal626’s Notes" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                依赖注入框架Dagger2系统性学习
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-29T15:16:16+08:00">
                2016-11-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/11/29/dagger2文档翻译/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/29/dagger2文档翻译/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/11/29/dagger2文档翻译/" class="leancloud_visitors" data-flag-title="依赖注入框架Dagger2系统性学习">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><strong><span id="top">目录</span></strong></p>
<blockquote>
<p><a href="#home">Home</a><br><a href="#guide">User’s Guide</a><br><a href="#android">Android</a><br><a href="#multibindings">Multibinding Sets and Maps</a><br><a href="#subcomponent">Subcomponents</a><br><a href="#producers">Producers</a><br><a href="#testing">Testing</a><br><a href="#project">Project Pages</a>  </p>
</blockquote>
<p><a href="#bottom">到底部</a></p>
<h2 id="Home"><a href="#Home" class="headerlink" title="Home"></a><span id="home">Home</span></h2><p>Dagger是一个完全静态的编译时的Java和Android依赖注入矿建。它由<a href="http://square.github.io/" target="_blank" rel="external">Square</a>发布的早期版本改造而来现在由Google维护。</p>
<p>Dagger致力于解决开发中使用基于反射的的解决方案带来的性能问题。更多详情可以在<a href="https://docs.google.com/presentation/d/1fby5VeGU9CN8zjw4lAb2QPPsKRxx6mSwCe9q7ECNSJQ/pub?start=false&amp;loop=false&amp;delayms=3000&amp;slide=id.p" target="_blank" rel="external">这里</a>找到 by <a href="https://plus.google.com/+GregoryKick/posts" target="_blank" rel="external">+Gregory Kick</a>.</p>
<h3 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h3><ul>
<li><a href="http://google.github.io/dagger/users-guide" target="_blank" rel="external">User documentation</a></li>
<li><a href="http://google.github.io/dagger/api/latest/" target="_blank" rel="external">Dagger API @ HEAD</a></li>
</ul>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><ul>
<li><a href="https://github.com/google/dagger" target="_blank" rel="external">https://github.com/google/dagger</a></li>
</ul>
<h3 id="有问题？"><a href="#有问题？" class="headerlink" title="有问题？"></a>有问题？</h3><ul>
<li>在Stack Overflow <a href="http://stackoverflow.com/questions/tagged/dagger-2" target="_blank" rel="external">dagger-2</a>专题下提问</li>
<li>发送邮件到<a href="https://groups.google.com/forum/#!forum/dagger-discuss" target="_blank" rel="external">dagger-discuss@googlegroups.com</a></li>
</ul>
<h2 id="User’s-Guide"><a href="#User’s-Guide" class="headerlink" title="User’s Guide"></a><span id="guide">User’s Guide</span></h2><p>应用中好的类是那些做了事情实现了功能的类，例如：BarcodeDecoder、KoopaPhysicsEngine和AudioStreamer。这些类可能依赖了其他类，如：BarcodeCameraFinder、DefaultPhysicsEngine及HttpStreamer。</p>
<p>相比之下，应用中那些糟糕的类往往占用空间却没做什么事，例如：BarcodeDecoderFactory、CameraServiceLoader以及MutableContextWrapper，这些类就像胶带一样笨拙地将相关的东西捆在一起。</p>
<p>实现了<a href="https://en.wikipedia.org/wiki/Dependency_injection" target="_blank" rel="external">依赖注入</a>设计模式而且不需要书写模板的Dagger是这些工厂类的替代品。它可以让你专注于你感兴趣的类。声明依赖，然后指定怎么注入它们，然后发布你的应用。</p>
<p>构建基于标准<a href="http://docs.oracle.com/javaee/7/api/javax/inject/package-summary.html" target="_blank" rel="external">javax.inject</a>注解（<a href="https://jcp.org/en/jsr/detail?id=330" target="_blank" rel="external">JSR 330</a>），类的测试更容易。你不需要写一大堆样板文件只需要用FakeCreditCardService替换RpcCreditCardService即可。</p>
<p>依赖注入不仅仅应用于测试。它还便于创建通用的，可复用的模块。你可以在你所有的应用共享一个AuthenticationModule。你还可以在开发环境中运行DevLoggingModule，在生产环境中运行ProdLoggingModule以在不同情景下都能达到正确的行为。</p>
<h3 id="Dagger2的亮点"><a href="#Dagger2的亮点" class="headerlink" title="Dagger2的亮点 "></a><span id="jump">Dagger2的亮点 </span></h3><p>依赖注入的框架已经存在好多年了并且拥有多种多样的API来配置和注入。那为什么要重新造轮子呢？Dagger2是第一个使用生成的代码实现全栈的依赖注入框架。指导原则是模仿用户手写的代码来生成代码尽可能地保证依赖注入过程简单、可追踪、高性能。想了解更多关于这种设计的信息请观看<a href="https://www.youtube.com/watch?v=oK_XtfXPkqw&amp;feature=youtu.be" target="_blank" rel="external">视频</a>(<a href="https://docs.google.com/presentation/d/1fby5VeGU9CN8zjw4lAb2QPPsKRxx6mSwCe9q7ECNSJQ/pub?start=false&amp;loop=false&amp;delayms=3000&amp;slide=id.p" target="_blank" rel="external">幻灯片</a>) by <a href="https://plus.google.com/+GregoryKick/posts" target="_blank" rel="external">+Gregory Kick</a>。</p>
<h3 id="Using-Dagger"><a href="#Using-Dagger" class="headerlink" title="Using Dagger"></a>Using Dagger</h3><p>我们将通过建造一个咖啡机的过程来演示依赖注入和Dagger.可编译运行的完整样例代码请看Dagger的<a href="https://github.com/google/dagger/tree/master/examples/simple/src/main/java/coffee" target="_blank" rel="external">咖啡样例</a>。</p>
<h4 id="声明依赖"><a href="#声明依赖" class="headerlink" title="声明依赖"></a>声明依赖</h4><p>Dagger构建你的应用中的实例并满足他们的依赖。它使用<a href="http://docs.oracle.com/javaee/7/api/javax/inject/Inject.html" target="_blank" rel="external">javax.inject.Inject</a>注解来标识感兴趣的构造器和字段。</p>
<p>使用@Inject注解告诉Dagger创建类的实例应该用的构造器。当需要一个实例对象时，Dagger将会获得需要的参数并调用这个构造器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Thermosiphon</span> <span class="keyword">implements</span> <span class="title">Pump</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Heater heater;</div><div class="line"></div><div class="line">  <span class="meta">@Inject</span></div><div class="line">  Thermosiphon(Heater heater) &#123;</div><div class="line">    <span class="keyword">this</span>.heater = heater;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Dagger 可以直接注入字段（成员变量）。在这个例子中，它拿到Heater类实例对象和Pump类实例对象分别赋值给CoffeeMaker的heater字段和pump字段。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CoffeeMaker</span> </span>&#123;</div><div class="line"><span class="meta">@Inject</span> Heater heater;</div><div class="line"><span class="meta">@Inject</span> Pump pump;</div><div class="line"></div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果你的类有使用@Inject注解的字段但没有@Inject注解了的构造器与之对应，Dagger会注入这些字段但不会创建新的实例。添加一个带有@Inject注解的无参构造器来告诉Dagger可以创建对象。</p>
<p>Dagger也支持方法注入，但更推荐构造器注入和字段注入。</p>
<p>缺少@Inject注解的类是不能被Dagger构建的。</p>
<h4 id="实现依赖"><a href="#实现依赖" class="headerlink" title="实现依赖"></a>实现依赖</h4><p>默认情况下，Dagger会通过创建需要类型的实例来提供依赖。当你需要一个CoffeeMaker，它会通过new CoffeeMaker()来获得一个实例并赋值给需要注入的字段。</p>
<p>但@Inject不是哪都有效的：</p>
<ul>
<li>接口不能被创建（不支持接口注入）</li>
<li>第三方的类不能被注解（第三方类没有@Inject注解，除非可以改源码）</li>
<li>可配置的对象必须配置好（这个应该是泛型，本人在使用时发现注入是不支持泛型的）</li>
</ul>
<p>在上面这些场景下@Inject就有些尴尬了，使用@Provides注解方法来实现依赖。方法的返回类型与其要实现的依赖一致。<br>例如：只要需要Heater实例就会调用provideHeater()方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Provides</span> <span class="function"><span class="keyword">static</span> Heater <span class="title">provideHeater</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ElectricHeater();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>@Provides标注的方法可以依赖他们自己。任何时候当需要Pump对象时，下面这个方法返回一个Thermosiphon对象。<br>所有的@Provides注解的方法必须属于一个Module.这些类只是有@Module注解的类。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DripCoffeeModule</span> </span>&#123;</div><div class="line">  <span class="meta">@Provides</span> <span class="function"><span class="keyword">static</span> Heater <span class="title">provideHeater</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ElectricHeater();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Provides</span> <span class="function"><span class="keyword">static</span> Pump <span class="title">providePump</span><span class="params">(Thermosiphon pump)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> pump;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>按照惯例，@Provides方法命名带provide前缀，module类命名带Module后缀。</p>
<h4 id="建立对象图"><a href="#建立对象图" class="headerlink" title="建立对象图"></a>建立对象图</h4><p>@Inject和@Provides注解的类通过他们的依赖关系联系起来形成对象图。调用代码就像一个应用的main方法或者Android应用通过一组明确定义的根集访问那个对象图。Dagger2中，那个集合是由一个包含返回需要类型且无参的方法的接口定义。通过<a href="http://google.github.io/dagger/api/latest/dagger/Component.html" target="_blank" rel="external">@Component</a>注解这个接口并传入<a href="http://google.github.io/dagger/api/latest/dagger/Module.html" target="_blank" rel="external">module</a>类型的参数，Dagger2然后根据这个协议生成所有实现。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span>(modules = DripCoffeeModule.class)</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">CoffeeShop</span> </span>&#123;</div><div class="line">  <span class="function">CoffeeMaker <span class="title">maker</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>实现类的类名与接口的名字加上Dagger前缀相同。通过调用实现类的builder()方法可以获得<a href="https://en.wikipedia.org/wiki/Builder_pattern" target="_blank" rel="external">Builder</a>实例，通过这个实例可以设置依赖并build()得到一个新的实例。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">CoffeeShop coffeeShop = DaggerCoffeeShop.builder()</div><div class="line">   .dripCoffeeModule(<span class="keyword">new</span> DripCoffeeModule())</div><div class="line">   .build();</div></pre></td></tr></table></figure></p>
<p><em>Note:</em> 如果你的@Component不是顶层的类型，那生成的component的名字将会包含它的封闭类型的名字，通过下划线连接。例如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</div><div class="line"> 		<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Bar</span> </span>&#123;</div><div class="line">   		<span class="meta">@Component</span></div><div class="line">   		<span class="class"><span class="keyword">interface</span> <span class="title">BazComponent</span> </span>&#123;&#125;</div><div class="line">  	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>将会生成名为DaggerFoo_ Bar_BazComponent的component.</p>
<p>任何有可达的默认构造器的module都可以被省略，如果没有设置builder会自动创建一个实例。而且任何@Provides方法都是静态的module,builder是不需要其实例的。如果不需要用户创建依赖实例就可以创建所有的依赖，那么生成的实现类将会包含一个create()方法，可以使用此方法得到一个实例而不用于builder打交道。</p>
<pre><code>CoffeeShop coffeeShop = DaggerCoffeeShop.create();
</code></pre><p>现在，我们的CoffeeApp可以方便的通过Dagger生成的实现来得到一个完全注入的CoffeeMaker.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CoffeeApp</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    CoffeeShop coffeeShop = DaggerCoffeeShop.create();</div><div class="line">    coffeeShop.maker().brew();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在图已经建立了入口也已经注入了，我们开启我们的咖啡机应用。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ java -cp ... coffee.CoffeeApp</div><div class="line">~ ~ ~ heating ~ ~ ~</div><div class="line">=&gt; =&gt; pumping =&gt; =&gt;</div><div class="line">[_]P coffee! [_]P</div></pre></td></tr></table></figure></p>
<p><strong>对象图中的绑定</strong></p>
<p>上面的例子展现如何构建一个拥有一些典型绑定的component，但还有不同的机制来为图贡献绑定。作为依赖下面这些是可用的而且可以用来生成更好的component.</p>
<ul>
<li>这些@Module中由@Provides声明的方法可以直接被@Component.modules或@Module.includes引用</li>
<li>任何类型的@Inject注解的构造器可以没有作用域也可以有与某个Component作用域一致的@Scope注解</li>
<li><a href="http://google.github.io/dagger/api/latest/dagger/Component.html#provision-methods" target="_blank" rel="external">component依赖</a>的<a href="http://google.github.io/dagger/api/latest/dagger/Component.html#dependencies(" target="_blank" rel="external">component提供方法</a>)</li>
<li>component自己</li>
<li>任何包含的<a href="http://google.github.io/dagger/api/latest/dagger/Subcomponent.html" target="_blank" rel="external">subcomponent</a>的不合格的<a href="http://google.github.io/dagger/api/latest/dagger/Subcomponent.Builder.html" target="_blank" rel="external">builders</a></li>
<li>上面所有绑定的Provider和Lazy 包装器。</li>
<li>上面绑定的懒加载的供应器（e.g Provider<lazy<coffeemaker>&gt;）</lazy<coffeemaker></li>
<li>任何类型的MemberInjector</li>
</ul>
<h4 id="单例和域绑定"><a href="#单例和域绑定" class="headerlink" title="单例和域绑定"></a>单例和域绑定</h4><p>用<a href="http://docs.oracle.com/javaee/7/api/javax/inject/Singleton.html" target="_blank" rel="external">@Singleton</a>注解@Provide方法或可注入的类，对象图将会在应用中使用同一个一个实例。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Provides</span> <span class="meta">@Singleton</span> <span class="function"><span class="keyword">static</span> Heater <span class="title">provideHeater</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> ElectricHeater();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可注入的类上的@Singleton注解也可以作为<a href="http://docs.oracle.com/javase/7/docs/api/java/lang/annotation/Documented.html" target="_blank" rel="external">文档</a>。它告诉潜在的维护者这个类可能被多个线程共享。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Singleton</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CoffeeMaker</span> </span>&#123;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>因为Dagger2会将图中添加了作用域的实例和component实现类的实例联系起来，所以这些component需要声明作用域。例如：在同一个component中使用@Singleton和@RequestScoped是没有意义的，因为他们具有不同的生命周期。想要声明一个具有作用域的component，只需要在该接口添加域注解。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span>(modules = DripCoffeeModule.class)</div><div class="line"><span class="meta">@Singleton</span></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">CoffeeShop</span> </span>&#123;</div><div class="line">  <span class="function">CoffeeMaker <span class="title">maker</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Components可以有多种域注解。表明这些注解是同一个域的别名，这样component就可以包含它声明的域的所有绑定了。</p>
<h4 id="可重用的scope"><a href="#可重用的scope" class="headerlink" title="可重用的scope"></a>可重用的scope</h4><p>有时你可能想限制@Inject注解的构造器初始化的次数或者@Provides方法被调用的次数，但并不需要保证单例。这在内存比较吃紧的环境比如Android下会很有用。</p>
<p>当你使用<a href="http://google.github.io/dagger/api/latest/dagger/Reusable.html" target="_blank" rel="external">@Resuable</a>注解，这些@Resuable域绑定不像其他的域，不会和任何component联系，相反，每个使用这个绑定component会将返回值或初始化的对象缓存起来。</p>
<p>这意味着如果你在component中装载了@Resuable绑定的module,但只有一个子component使用了，那么那个子component将会缓存此绑定的对象。如果两个子component都使用了这个绑定但他们不继承同一个component，那么这两个子component的缓存是独立的。如果component已经缓存了对象，其子component会重用该对象。</p>
<p>并不能保证component只会调用该绑定一次，所以在返回可变对象或者需要使用单例的绑定上使用@Resuable是很危险的。对不关心被分配多少次的不变对象使用@Resuable是安全的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Reusable</span> <span class="comment">// 我们用了多少scopers并不重要，但不要浪费他们。</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CoffeeScooper</span> </span>&#123;</div><div class="line">  <span class="meta">@Inject</span> CoffeeScooper() &#123;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CashRegisterModule</span> </span>&#123;</div><div class="line">  <span class="meta">@Provides</span></div><div class="line">  <span class="meta">@Reusable</span> <span class="comment">// 不要这样做！你是关注你保存cash的register的</span></div><div class="line">            <span class="comment">// Use a specific scope instead.</span></div><div class="line">  <span class="function"><span class="keyword">static</span> CashRegister <span class="title">badIdeaCashRegister</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CashRegister();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">  </div><div class="line"><span class="meta">@Reusable</span> <span class="comment">// 不要这样做！ 你实际想每次都拿到新的filter对象，所以这里不需要使用域。</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CoffeeFilter</span> </span>&#123;</div><div class="line">  <span class="meta">@Inject</span> CoffeeFilter() &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="延迟注入"><a href="#延迟注入" class="headerlink" title="延迟注入"></a>延迟注入</h4><p>有时你需要延迟初始化对象。对于任意绑定T，你可以创建<a href="http://google.github.io/dagger/api/latest/dagger/Lazy.html" target="_blank" rel="external">Lazy<t></t></a>，这样就可以延迟对象初始化直到调用Lazy<t>的get()方法。如果T是单例的，那么在对象图中所有的注入都是同一个Lazy<t>实例。否则每个注入拿到的都是自己的Lazy<t>实例。对同一个Lazy<t>实例连续调用get()方法返回的都是一个T对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">GridingCoffeeMaker</span> </span>&#123;</div><div class="line">  <span class="meta">@Inject</span> Lazy&lt;Grinder&gt; lazyGrinder;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">brew</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">while</span> (needsGrinding()) &#123;</div><div class="line">      <span class="comment">//第一次调用get()时会创建Grinder对象并缓存起来</span></div><div class="line">      lazyGrinder.get().grind();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></t></t></t></t></p>
<h4 id="Provider注入"><a href="#Provider注入" class="headerlink" title="Provider注入"></a>Provider注入</h4><p>有时你需要返回多个实例而不是注入单个值。你有多种选择（Factories,Builders,等等）,其中一种选择就是注入一个Provider<t>而不是T。每次调用get()方法时Provider<t>会调用绑定逻辑。如果那个绑定逻辑是@Inject注解的构造器，会创建一个新对象，但一个@Provides方法是无法保证这点的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BigCoffeeMaker</span> </span>&#123;</div><div class="line">  <span class="meta">@Inject</span> Provider&lt;Filter&gt; filterProvider;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">brew</span><span class="params">(<span class="keyword">int</span> numberOfPots)</span> </span>&#123;</div><div class="line">  ...</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; numberOfPots; p++) &#123;</div><div class="line">      maker.addFilter(filterProvider.get()); <span class="comment">//每次都是新的filter对象	      </span></div><div class="line">      maker.addCoffee(...);</div><div class="line">      maker.percolate();</div><div class="line">      ...</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></t></t></p>
<p><em>Note:</em> 注入Provider<t>可能降低代码的可读性。通常你会用一个<a href="https://en.wikipedia.org/wiki/Factory_(object-oriented_programming" target="_blank" rel="external">factory</a>)或一个Lazy<t>或是重新组织代码的结构和生命周期来注入一个T。但注入Provider<t>有些情况可以救命。一个通常的使用场景就是当你必须使用一个遗留的并不与你的对象的自然生命周期一样的架构时。（例如：按照设计servlets是单例的，但只有在明确请求数据的上下文中中是有效的）。</t></t></t></p>
<h4 id="Qualifiers"><a href="#Qualifiers" class="headerlink" title="Qualifiers"></a>Qualifiers</h4><p>有时类型不足以区分依赖。例如：一个复杂的咖啡机想要将睡和盘子的加热器分开。</p>
<p>这种情况，我们添加一个<strong>qualifier annotation</strong>。这是任何本身有<a href="http://docs.oracle.com/javaee/7/api/javax/inject/Qualifier.html" target="_blank" rel="external">@Qualifier</a>注解的注解。下面是<a href="http://docs.oracle.com/javaee/7/api/javax/inject/Named.html" target="_blank" rel="external">@Named</a>的声明，它是javax.inject中的注解。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Qualifier</span></div><div class="line"><span class="meta">@Documented</span></div><div class="line"><span class="meta">@Retention</span>(RUNTIME)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Named &#123;</div><div class="line">  <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>你可以创建自定义的qualifier注解，或使用@Named.在关心的字段或参数上使用qualifiers.类型+qualifier将会用来标识一个依赖。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExpensiveCoffeeMaker</span> </span>&#123;</div><div class="line">  <span class="meta">@Inject</span> <span class="meta">@Named</span>(<span class="string">"water"</span>) Heater waterHeater;</div><div class="line">  <span class="meta">@Inject</span> <span class="meta">@Named</span>(<span class="string">"hot plate"</span>) Heater hotPlateHeater;</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注解对应的@Provides方法来提供限定的值。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Provides</span> <span class="meta">@Named</span>(<span class="string">"hot plate"</span>) <span class="function"><span class="keyword">static</span> Heater <span class="title">provideHotPlateHeater</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ElectricHeater(<span class="number">70</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Provides</span> <span class="meta">@Named</span>(<span class="string">"water"</span>) <span class="function"><span class="keyword">static</span> Heater <span class="title">provideWaterHeater</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ElectricHeater(<span class="number">93</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>依赖可以有多个qualifier注解。</p>
<h4 id="编译期校验"><a href="#编译期校验" class="headerlink" title="编译期校验"></a>编译期校验</h4><p>Dagger的注解处理器会生成名如CoffeeMaker_Factory.java或CoffeeMaker_MembersInjector.java的源文件。这些文件就是Dagger的实现细节。你不需要直接使用它们，虽然通过注解单步调试时会很方便。唯一需要你关心的是那些带有Dagger前缀的为component生成的代码。</p>
<h3 id="Using-Dagger-In-Your-Build"><a href="#Using-Dagger-In-Your-Build" class="headerlink" title="Using Dagger In Your Build"></a>Using Dagger In Your Build</h3><h4 id="Gradle-Users"><a href="#Gradle-Users" class="headerlink" title="Gradle Users"></a>Gradle Users</h4><p>你需要引入运行时依赖dagger-2.2.jar，为了激活代码生成还要引入编译期依赖dagger-compiler-2.2.jar.</p>
<p>Maven工程在pom.xml如下配置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.dagger<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dagger<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.dagger<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dagger-compiler<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><strong>Android Gradle</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Add plugin https://bitbucket.org/hvisser/android-apt</span></div><div class="line">buildscript &#123;</div><div class="line">  repositories &#123;</div><div class="line">    mavenCentral()</div><div class="line">  &#125;</div><div class="line">  dependencies &#123;</div><div class="line">    classpath <span class="string">'com.neenbedankt.gradle.plugins:android-apt:1.8'</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Apply plugin</span></div><div class="line">apply plugin: <span class="string">'com.neenbedankt.android-apt'</span></div><div class="line"></div><div class="line"><span class="comment">// Add Dagger dependencies</span></div><div class="line">dependencies &#123;</div><div class="line">  compile <span class="string">'com.google.dagger:dagger:2.x'</span></div><div class="line">  apt <span class="string">'com.google.dagger:dagger-compiler:2.x'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Dagger-amp-Android"><a href="#Dagger-amp-Android" class="headerlink" title="Dagger&amp;Android"></a><span id="android">Dagger&amp;Android</span></h2><p>相对于其他依赖注入框架Dagger2最基本的优势之一就是完全生成代码（没有反射），这意味着它是可以应用于Anroid的。但当使用时还是有一些需要注意的地方。</p>
<h3 id="原理（Philosophy）"><a href="#原理（Philosophy）" class="headerlink" title="原理（Philosophy）"></a>原理（Philosophy）</h3><p>因为针对Android编写的代码是Java代码，所以在风格上常有很大区别，这种差异的存在以适应Android平台独特<a href="http://developer.android.com/training/best-performance.html" target="_blank" rel="external">性能</a>考虑。</p>
<p>为了生成通用且轻便的代码，Dagger基于<a href="http://proguard.sourceforge.net/" target="_blank" rel="external">ProGuard</a>对编译后的字节码进行后期处理。这样Dagger可以产生在server和Android上都很自然的代码，使用不同的工具链是生成的字节码在两个环境下都能高效执行。此外，Dagger可以明确保证其生成的Java代码在ProGuard优化后是可编译。</p>
<h2 id="多重绑定-Multibindings"><a href="#多重绑定-Multibindings" class="headerlink" title="多重绑定(Multibindings)"></a><span id="multibindings">多重绑定(Multibindings)</span></h2><p>Dagger支持将多个对象绑定进一个集合即使这些对象已经绑定在不同的module中。</p>
<p>你可以使用多重绑定实现插件架构，例如：不同的module都可以贡献自己对插件接口的实现这样中央类就可以使用这些插件集合。或者你可以有多个module贡献各自的service providers，以名称为键保存在一个map中。</p>
<h3 id="Set-multibindings"><a href="#Set-multibindings" class="headerlink" title="Set multibindings"></a>Set multibindings</h3><p>在module的方法上添加<a href="http://google.github.io/dagger/api/latest/dagger/multibindings/IntoSet.html" target="_blank" rel="external">@IntoSet</a>注解，向一个可注入的多重绑定的set贡献元素。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyModuleA</span> </span>&#123;</div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoSet</span></div><div class="line">  <span class="function"><span class="keyword">static</span> String <span class="title">provideOneString</span><span class="params">(DepA depA, DepB depB)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"ABC"</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>你还可以在返回值为集合的方法使用<a href="http://google.github.io/dagger/api/latest/dagger/multibindings/ElementsIntoSet.html" target="_blank" rel="external">@ElementsIntoSet</a>注解来同时贡献多个元素。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyModuleB</span> </span>&#123;</div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@ElementsIntoSet</span></div><div class="line">  <span class="function"><span class="keyword">static</span> Set&lt;String&gt; <span class="title">provideSomeStrings</span><span class="params">(DepA depA, DepB depB)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HashSet&lt;String&gt;(Arrays.asList(<span class="string">"DEF"</span>, <span class="string">"GHI"</span>));</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在component的一个绑定可以依赖这个set了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bar</span> </span>&#123;</div><div class="line">  <span class="meta">@Inject</span> Bar(Set&lt;String&gt; strings) &#123;</div><div class="line">    <span class="keyword">assert</span> strings.contains(<span class="string">"ABC"</span>);</div><div class="line">    <span class="keyword">assert</span> strings.contains(<span class="string">"DEF"</span>);</div><div class="line">    <span class="keyword">assert</span> strings.contains(<span class="string">"GHI"</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>component也可以提供这个set:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span>(modules = &#123;MyModuleA.class, MyModuleB.class&#125;)</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">MyComponent</span> </span>&#123;</div><div class="line">  <span class="function">Set&lt;String&gt; <span class="title">strings</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Test</span> <span class="function"><span class="keyword">void</span> <span class="title">testMyComponent</span><span class="params">()</span> </span>&#123;</div><div class="line">  MyComponent myComponent = DaggerMyComponent.create();</div><div class="line">  assertThat(myComponent.strings()).containsExactly(<span class="string">"ABC"</span>, <span class="string">"DEF"</span>, <span class="string">"GHI"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>除了可以依赖多重绑定的Set<foo>，还可以依赖Provider<set<foo>&gt;或者Lazy<set<foo>&gt;，不可以依赖Set<provider<foo>&gt;.</provider<foo></set<foo></set<foo></foo></p>
<p>给每个@Provides方法添加qualifier向限定的多重绑定set贡献元素。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyModuleC</span> </span>&#123;</div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoSet</span></div><div class="line">  <span class="meta">@MyQualifier</span></div><div class="line">  <span class="function"><span class="keyword">static</span> Foo <span class="title">provideOneFoo</span><span class="params">(DepA depA, DepB depB)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Foo(depA, depB);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyModuleD</span> </span>&#123;</div><div class="line">  <span class="meta">@Provides</span></div><div class="line">  <span class="function"><span class="keyword">static</span> FooSetUser <span class="title">provideFooSetUser</span><span class="params">(@MyQualifier Set&lt;Foo&gt; foos)</span> </span>&#123; … &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Map-multibindings"><a href="#Map-multibindings" class="headerlink" title="Map multibindings"></a>Map multibindings</h4><p>Dagger支持使用多重绑定向一个可注入的map贡献entry只要这个map的key在编译期是可见的。</p>
<p>在module中添加带有返回值的方法添加<a href="http://google.github.io/dagger/api/latest/dagger/multibindings/IntoMap.html" target="_blank" rel="external">@IntoMap</a>注解和指定key的自定义注解。为了向一个限定的多重绑定map贡献entry,需要给每个@IntoMap方法添加qualifier注解。</p>
<p>然后你就可以注入map(Map<k,v>)本身或包含providers的map(Map<k,provider<v>&gt;).当你不想一次初始化所有对象而是想一次只拿到一个值的时候或当你想在每次查询map时都拿到新的对象时后者更有用。</k,provider<v></k,v></p>
<h5 id="Simple-map-keys"><a href="#Simple-map-keys" class="headerlink" title="Simple map keys"></a>Simple map keys</h5><p>对于那些键是string、Class&lt;?&gt;或封装的原始类型的map,使用<a href="http://google.github.io/dagger/api/latest/dagger/mapkeys/package-summary.html" target="_blank" rel="external">dagger.mapkeys</a>中定义的标准注解.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyModule</span> </span>&#123;</div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoMap</span></div><div class="line">  <span class="meta">@StringKey</span>(<span class="string">"foo"</span>)</div><div class="line">  <span class="function"><span class="keyword">static</span> Long <span class="title">provideFooValue</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">100L</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoMap</span></div><div class="line">  <span class="meta">@ClassKey</span>(Thing.class)</div><div class="line">  <span class="function"><span class="keyword">static</span> String <span class="title">provideThingValue</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"value for Thing"</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Component</span>(modules = MyModule.class)</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">MyComponent</span> </span>&#123;</div><div class="line">  <span class="function">Map&lt;String, Long&gt; <span class="title">longsByString</span><span class="params">()</span></span>;</div><div class="line">  Map&lt;Class&lt;?&gt;, String&gt; stringsByClass();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Test</span> <span class="function"><span class="keyword">void</span> <span class="title">testMyComponent</span><span class="params">()</span> </span>&#123;</div><div class="line">  MyComponent myComponent = DaggerMyComponent.create();</div><div class="line">  assertThat(myComponent.longsByString().get(<span class="string">"foo"</span>)).isEqualTo(<span class="number">100L</span>);</div><div class="line">  assertThat(myComponent.stringsByClass().get(Thing.class))</div><div class="line">      .isEqualTo(<span class="string">"value for Thing"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>对于key是枚举或泛型化类的map,定义一个包含map的key类型成员的注解并添加<a href="http://google.github.io/dagger/api/latest/dagger/MapKey.html" target="_blank" rel="external">@MapKey</a>注解。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> MyEnum &#123;</div><div class="line">  ABC, DEF;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@MapKey</span></div><div class="line"><span class="meta">@interface</span> MyEnumKey &#123;</div><div class="line">  <span class="function">MyEnum <span class="title">value</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@MapKey</span></div><div class="line"><span class="meta">@interface</span> MyNumberClassKey &#123;</div><div class="line">  Class&lt;? extends Number&gt; value();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyModule</span> </span>&#123;</div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoMap</span></div><div class="line">  <span class="meta">@MyEnumKey</span>(MyEnum.ABC)</div><div class="line">  <span class="function"><span class="keyword">static</span> String <span class="title">provideABCValue</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"value for ABC"</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoMap</span></div><div class="line">  <span class="meta">@MyNumberClassKey</span>(BigDecimal.class)</div><div class="line">  <span class="function"><span class="keyword">static</span> String <span class="title">provideBigDecimalValue</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"value for BigDecimal"</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Component</span>(modules = MyModule.class)</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">MyComponent</span> </span>&#123;</div><div class="line">  <span class="function">Map&lt;MyEnum, String&gt; <span class="title">myEnumStringMap</span><span class="params">()</span></span>;</div><div class="line">  Map&lt;Class&lt;? extends Number&gt;, String&gt; stringsByNumberClass();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Test</span> <span class="function"><span class="keyword">void</span> <span class="title">testMyComponent</span><span class="params">()</span> </span>&#123;</div><div class="line">  MyComponent myComponent = DaggerMyComponent.create();</div><div class="line">  assertThat(myComponent.myEnumStringMap().get(MyEnum.ABC)).isEqualTo(<span class="string">"value for ABC"</span>);</div><div class="line">  assertThat(myComponent.stringsByNumberClass.get(BigDecimal.class))</div><div class="line">      .isEqualTo(<span class="string">"value for BigDecimal"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>你的自定义注解可以是任何名字，并且可以是任何正确的注解成员类型除了数组类型。</p>
<h5 id="Complex-map-keys"><a href="#Complex-map-keys" class="headerlink" title="Complex map keys"></a>Complex map keys</h5><p>如果用一个注解成员不足以描述你的map的key,你可以使用整个注解作为key,只把@MapKey的unwrapValue设置为false，在这种情况下，自定义注解也可以包含数组成员。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@MapKey</span>(unwrapValue = <span class="keyword">false</span>)</div><div class="line"><span class="meta">@interface</span> MyKey &#123;</div><div class="line">  <span class="function">String <span class="title">name</span><span class="params">()</span></span>;</div><div class="line">  Class&lt;?&gt; implementingClass();</div><div class="line">  <span class="keyword">int</span>[] thresholds();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyModule</span> </span>&#123;</div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoMap</span></div><div class="line">  <span class="meta">@MyKey</span>(name = <span class="string">"abc"</span>, implementingClass = Abc.class, thresholds = &#123;<span class="number">1</span>, <span class="number">5</span>, <span class="number">10</span>&#125;)</div><div class="line">  <span class="function"><span class="keyword">static</span> String <span class="title">provideAbc1510Value</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"foo"</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Component</span>(modules = MyModule.class)</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">MyComponent</span> </span>&#123;</div><div class="line">  <span class="function">Map&lt;MyKey, String&gt; <span class="title">myKeyStringMap</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>使用@AutoAnnotation来创建注解实例。<br>如果map使用复杂key,那你可能需要在运行时创建@MapKey注解实例传给get(Object)方法。最简单的做法是使用@AutoAnnotation创建初始化注解实例的静态方法。更多细节查看@AutoAnnotation<a href="https://github.com/google/auto/blob/master/value/src/main/java/com/google/auto/value/AutoAnnotation.java" target="_blank" rel="external">文档</a>。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyComponentTest</span> </span>&#123;</div><div class="line">  <span class="meta">@Test</span> <span class="function"><span class="keyword">void</span> <span class="title">testMyComponent</span><span class="params">()</span> </span>&#123;</div><div class="line">    MyComponent myComponent = DaggerMyComponent.create();</div><div class="line">    assertThat(myComponent.myKeyStringMap()</div><div class="line">        .get(createMyKey(<span class="string">"abc"</span>, Abc.class, <span class="keyword">new</span> <span class="keyword">int</span>[] &#123;<span class="number">1</span>, <span class="number">5</span>, <span class="number">10</span>&#125;))</div><div class="line">        .isEqualTo(<span class="string">"foo"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@AutoAnnotation</span></div><div class="line">  <span class="function"><span class="keyword">static</span> MyKey <span class="title">createMyKey</span><span class="params">(String name, Class&lt;?&gt; implementingClass, <span class="keyword">int</span>[] thresholds)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> AutoAnnotation_MyComponentTest_createMyKey(name, implementingClass, thresholds);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="Maps-whose-keys-are-not-known-at-compile-time"><a href="#Maps-whose-keys-are-not-known-at-compile-time" class="headerlink" title="Maps whose keys are not known at compile time"></a>Maps whose keys are not known at compile time</h5><p>编译期map的key可以确定或可以用注解表示的Map多重绑定才有效。如果你的map不满足这些限制，那就不能创建多重绑定map,但你可以使用set multibindings 绑定对象然后再转换为非多重绑定的map<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyModule</span> </span>&#123;</div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoSet</span></div><div class="line">  <span class="keyword">static</span> Map.<span class="function">Entry&lt;Foo, Bar&gt; <span class="title">entryOne</span><span class="params">(…)</span> </span>&#123;</div><div class="line">    Foo key = …;</div><div class="line">    Bar value = …;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SimpleImmutableEntry(key, value);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoSet</span></div><div class="line">  <span class="keyword">static</span> Map.<span class="function">Entry&lt;Foo, Bar&gt; <span class="title">entryTwo</span><span class="params">(…)</span> </span>&#123;</div><div class="line">    Foo key = …;</div><div class="line">    Bar value = …;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SimpleImmutableEntry(key, value);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyMapModule</span> </span>&#123;</div><div class="line">  <span class="meta">@Provides</span></div><div class="line">  <span class="function"><span class="keyword">static</span> Map&lt;Foo, Bar&gt; <span class="title">fooBarMap</span><span class="params">(Set&lt;Map.Entry&lt;Foo, Bar&gt;&gt; entries)</span> </span>&#123;</div><div class="line">    Map&lt;Foo, Bar&gt; fooBarMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(entries.size());</div><div class="line">    <span class="keyword">for</span> (Map.Entry&lt;Foo, Bar&gt; entry : entries) &#123;</div><div class="line">      fooBarMap.put(entry.getKey(), entry.getValue());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> fooBarMap;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注意这种方式就不会有Map<foo,provider<bar>&gt;的自动绑定了。如果你想要providers map，就需要multibound set的Map.Entry对象中包含providers。然后你的非多重绑定的map就可以有Provider值了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyModule</span> </span>&#123;</div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoSet</span></div><div class="line">  <span class="keyword">static</span> Map.Entry&lt;Foo, Provider&lt;Bar&gt;&gt; entry(</div><div class="line">      Provider&lt;BarSubclass&gt; barSubclassProvider) &#123;</div><div class="line">    Foo key = …;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SimpleImmutableEntry(key, barSubclassProvider);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyProviderMapModule</span> </span>&#123;</div><div class="line">  <span class="meta">@Provides</span></div><div class="line">  <span class="keyword">static</span> Map&lt;Foo, Provider&lt;Bar&gt;&gt; fooBarProviderMap(</div><div class="line">      Set&lt;Map.Entry&lt;Foo, Provider&lt;Bar&gt;&gt;&gt; entries) &#123;</div><div class="line">    <span class="keyword">return</span> …;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></foo,provider<bar></p>
<h4 id="Declaring-multibindings"><a href="#Declaring-multibindings" class="headerlink" title="Declaring multibindings"></a>Declaring multibindings</h4><p>你可以向module中返回set或map的方法添加<a href="http://google.github.io/dagger/api/latest/dagger/multibindings/Multibinds.html" target="_blank" rel="external">@Multibinds</a>注解来声明多重绑定的set或map.</p>
<p>对于至少有<a href="http://google.github.io/dagger/api/latest/dagger/multibindings/IntoSet.html" target="_blank" rel="external">@IntoSet</a>,<a href="http://google.github.io/dagger/api/latest/dagger/multibindings/ElementsIntoSet.html" target="_blank" rel="external">@ElementsIntoSet</a>,或<a href="http://google.github.io/dagger/api/latest/dagger/multibindings/IntoMap.html" target="_blank" rel="external">@IntoMap</a>绑定中一个的set或map没必要使用@Multibinds,但如果他们可能为空则必须要添加此声明。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">MyModule</span> </span>&#123;</div><div class="line">  <span class="meta">@Multibinds</span> <span class="function"><span class="keyword">abstract</span> Set&lt;Foo&gt; <span class="title">aSet</span><span class="params">()</span></span>;</div><div class="line">  <span class="meta">@Multibinds</span> <span class="meta">@MyQualifier</span> <span class="function"><span class="keyword">abstract</span> Set&lt;Foo&gt; <span class="title">aQualifiedSet</span><span class="params">()</span></span>;</div><div class="line">  <span class="meta">@Multibinds</span> <span class="function"><span class="keyword">abstract</span> Map&lt;String, Foo&gt; <span class="title">aMap</span><span class="params">()</span></span>;</div><div class="line">  <span class="meta">@Multibinds</span> <span class="meta">@MyQualifier</span> <span class="function"><span class="keyword">abstract</span> Map&lt;String, Foo&gt; <span class="title">aQualifiedMap</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>给定的set或map多重绑定可以被声明多次。Dagger不会实现或调用<a href="http://google.github.io/dagger/api/latest/dagger/multibindings/Multibinds.html" target="_blank" rel="external">@Multibinds</a>.</p>
<h5 id="Alternative-ElementsIntoSet-returning-an-empty-set"><a href="#Alternative-ElementsIntoSet-returning-an-empty-set" class="headerlink" title="Alternative: @ElementsIntoSet returning an empty set"></a>Alternative: @ElementsIntoSet returning an empty set</h5><p>对于空的set,作为替代方案，你可以在方法上添加<a href="http://google.github.io/dagger/api/latest/dagger/multibindings/ElementsIntoSet.html" target="_blank" rel="external">@ElementsIntoSet</a>.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyEmptySetModule</span> </span>&#123;</div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@ElementsIntoSet</span></div><div class="line">  <span class="function"><span class="keyword">static</span> Set&lt;Foo&gt; <span class="title">primeEmptyFooSet</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Collections.emptySet();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Inherited-subcomponent-multibindings"><a href="#Inherited-subcomponent-multibindings" class="headerlink" title="Inherited subcomponent multibindings"></a>Inherited subcomponent multibindings</h4><p>subcomponent中的绑定可以依赖父component中的多重绑定set或map,就像其他绑定也是可以依赖父类的一样。subcomponent也可以向父component中绑定的多重绑定set或map添加元素，只需在module中添加合适的@Provides方法。</p>
<p>这种情况下，set和map根据注入的位置不同而不同。当它注入到定义在subcomponent的绑定时，它就会包含subcomponent和其父component的值或entry。当注入到父component中定义的绑定时，那它只包含此处定义的值或entry。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span>(modules = ParentModule.class)</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ParentComponent</span> </span>&#123;</div><div class="line">  <span class="function">Set&lt;String&gt; <span class="title">strings</span><span class="params">()</span></span>;</div><div class="line">  <span class="function">Map&lt;String, String&gt; <span class="title">stringMap</span><span class="params">()</span></span>;</div><div class="line">  <span class="function">ChildComponent <span class="title">childComponent</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParentModule</span> </span>&#123;</div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoSet</span></div><div class="line">  <span class="function"><span class="keyword">static</span> String <span class="title">string1</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="string">"parent string 1"</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoSet</span></div><div class="line">  <span class="function"><span class="keyword">static</span> String <span class="title">string2</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="string">"parent string 2"</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoMap</span></div><div class="line">  <span class="meta">@StringKey</span>(<span class="string">"a"</span>)</div><div class="line">  <span class="function"><span class="keyword">static</span> String <span class="title">stringA</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="string">"parent string A"</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoMap</span></div><div class="line">  <span class="meta">@StringKey</span>(<span class="string">"b"</span>)</div><div class="line">  <span class="function"><span class="keyword">static</span> String <span class="title">stringB</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="string">"parent string B"</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Subcomponent</span>(modules = ChildModule.class)</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ChildComponent</span> </span>&#123;</div><div class="line">  <span class="function">Set&lt;String&gt; <span class="title">strings</span><span class="params">()</span></span>;</div><div class="line">  <span class="function">Map&lt;String, String&gt; <span class="title">stringMap</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChildModule</span> </span>&#123;</div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoSet</span></div><div class="line">  <span class="function"><span class="keyword">static</span> String <span class="title">string3</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="string">"child string 3"</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoSet</span></div><div class="line">  <span class="function"><span class="keyword">static</span> String <span class="title">string4</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="string">"child string 4"</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoMap</span></div><div class="line">  <span class="meta">@StringKey</span>(<span class="string">"c"</span>)</div><div class="line">  <span class="function"><span class="keyword">static</span> String <span class="title">stringC</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="string">"child string C"</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoMap</span></div><div class="line">  <span class="meta">@StringKey</span>(<span class="string">"d"</span>)</div><div class="line">  <span class="function"><span class="keyword">static</span> String <span class="title">stringD</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="string">"child string D"</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Test</span> <span class="function"><span class="keyword">void</span> <span class="title">testMultibindings</span><span class="params">()</span> </span>&#123;</div><div class="line">  ParentComponent parentComponent = DaggerParentComponent.create();</div><div class="line">  assertThat(parentComponent.strings()).containsExactly(</div><div class="line">      <span class="string">"parent string 1"</span>, <span class="string">"parent string 2"</span>);</div><div class="line">  assertThat(parentComponent.stringMap().keySet()).containsExactly(<span class="string">"a"</span>, <span class="string">"b"</span>);</div><div class="line"></div><div class="line">  ChildComponent childComponent = parentComponent.childComponent();</div><div class="line">  assertThat(childComponent.strings()).containsExactly(</div><div class="line">      <span class="string">"parent string 1"</span>, <span class="string">"parent string 2"</span>, <span class="string">"child string 3"</span>, <span class="string">"child string 4"</span>);</div><div class="line">  assertThat(childComponent.stringMap().keySet()).containsExactly(</div><div class="line">      <span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Subcomponents"><a href="#Subcomponents" class="headerlink" title="Subcomponents"></a><span id="subcomponent">Subcomponents</span></h2><p>继承和扩展父component对象图的component称为subcomponent。你可以使用它们把你的应用划分为不同子图，封装为不同的模块或在component中使用不同地域。</p>
<p>subcomponent中绑定的对象可以依赖绑定在父级component中的任意对象和自己module中绑定的对象，但不能依赖兄弟级component中绑定的对象。</p>
<p>换句话说，subcomponent的父级component的对象图是这subcomponent对象图的子图。</p>
<h3 id="Declaring-a-subcomponent"><a href="#Declaring-a-subcomponent" class="headerlink" title="Declaring a subcomponent"></a>Declaring a subcomponent</h3><p>就像声明上层component一样，创建<a href="http://google.github.io/dagger/api/latest/dagger/Component.html#component-methods" target="_blank" rel="external">抽象类或接口并声明抽象方法返回你需要的类型</a>，然后添加<a href="http://google.github.io/dagger/api/latest/dagger/Subcomponent.html" target="_blank" rel="external">@Subcomponent</a>注解而不是<a href="http://google.github.io/dagger/api/latest/dagger/Component.html" target="_blank" rel="external">@Component</a>，设置<a href="http://google.github.io/dagger/api/latest/dagger/Module.html" target="_blank" rel="external">@Modules</a>.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Subcomponent</span>(modules = RequestModule.class)</div><div class="line">inferface RequestComponent &#123;</div><div class="line">  <span class="function">RequestHandler <span class="title">requestHandler</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Adding-a-subcomponent-to-a-parent-component"><a href="#Adding-a-subcomponent-to-a-parent-component" class="headerlink" title="Adding a subcomponent to a parent component"></a>Adding a subcomponent to a parent component</h3><p>向父级component添加子component，只需在父级component添加返回值为子component的抽象工厂方法。如果子component需要一个没有无参构造器的module,需要在工厂方法添加该module类型的参数。这个工厂方法可能还有其他subcomponent中的module参数。（这个subcomponent会自动和parent component分享module实例）。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span>(modules = &#123;ServerModule.class, AuthModule.class&#125;)</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ServerComponent</span> </span>&#123;</div><div class="line">  <span class="function">Server <span class="title">server</span><span class="params">()</span></span>;</div><div class="line">  <span class="function">SessionComponent <span class="title">sessionComponent</span><span class="params">(SessionModule sessionModule)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Subcomponent</span>(modules = SessionModule.class)</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">SessionComponent</span> </span>&#123;</div><div class="line">  <span class="function">SessionInfo <span class="title">sessionInfo</span><span class="params">()</span></span>;</div><div class="line">  <span class="function">RequestComponent <span class="title">requestComponent</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Subcomponent</span>(modules = &#123;RequestModule.class, AuthModule.class&#125;)</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">RequestComponent</span> </span>&#123;</div><div class="line">  <span class="function">RequestHandler <span class="title">requestHandler</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>SessionComponent中绑定的module可以依赖ServerComponent中绑定的module,RequestComponent中绑定module同时依赖SessionComponent和ServerComponent绑定的module.</p>
<p>你可以通过调用parent component的工厂方法来创建subcomponent的实例。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ServerComponent serverComponent = DaggerServerComponent.create();</div><div class="line">SessionComponent sessionComponent =</div><div class="line">    serverComponent.sessionComponent(<span class="keyword">new</span> SessionModule(…));</div><div class="line">RequestComponent requestComponent = sessionComponent.requestComponent();</div></pre></td></tr></table></figure></p>
<p>通常你需要parent component中的对象绑定来创建subcomponent。为了完成这些，你可以基于任何component中的绑定都可以依赖这个component类型本身。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BoundInServerComponent</span> </span>&#123;</div><div class="line">  <span class="meta">@Inject</span> ServerComponent serverComponent;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">doSomethingWithSessionInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">    SessionComponent sessionComponent =</div><div class="line">        serverComponent.sessionComponent(<span class="keyword">new</span> SessionModule(…));</div><div class="line">    sessionComponent.sessionInfo().doSomething();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Subcomponent-builders"><a href="#Subcomponent-builders" class="headerlink" title="Subcomponent builders"></a>Subcomponent builders</h3><p>你也可以按照component builders的定义方式定为component定义builder.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span>(modules = &#123;ServerModule.class, AuthModule.class&#125;)</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ServerComponent</span> </span>&#123;</div><div class="line">  <span class="function">Server <span class="title">server</span><span class="params">()</span></span>;</div><div class="line">  SessionComponent.<span class="function">Builder <span class="title">sessionComponentBuilder</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Subcomponent</span>(modules = SessionModule.class)</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">SessionComponent</span> </span>&#123;</div><div class="line">  <span class="meta">@Subcomponent</span>.Builder</div><div class="line">  <span class="class"><span class="keyword">interface</span> <span class="title">Builder</span> </span>&#123;</div><div class="line">    <span class="function">Builder <span class="title">sessionModule</span><span class="params">(SessionModule sessionModule)</span></span>;</div><div class="line">    <span class="function">SessionComponent <span class="title">build</span><span class="params">()</span></span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">ServerComponent serverComponent = DaggerServerComponent.create();</div><div class="line">SessionComponent sessionComponent = serverComponent.sessionComponentBuilder()</div><div class="line">    .sessionModule(<span class="keyword">new</span> SessionModule(…))</div><div class="line">    .build();</div></pre></td></tr></table></figure></p>
<p><strong>注入subcomponent builder</strong><br>就像component本身一样，subcomponent builder也是绑定在对象图中的也可以被注入。所以与其注入component然后调用subcomponent builder方法不如直接注入builder。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** 注入subcomponent builder. 这比下面的方法要简单*/</span></div><div class="line"> <span class="class"><span class="keyword">class</span> <span class="title">SessionStarterInjectingSubcomponentBuilder</span> </span>&#123;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> SessionComponent.Builder sessionComponentBuilder;</div><div class="line">   </div><div class="line">   <span class="meta">@Inject</span> SessionStarterInjectingSubcomponentBuilder(</div><div class="line">       SessionComponent.Builder sessionComponentBuilder) &#123;</div><div class="line">     <span class="keyword">this</span>.sessionComponentBuilder = sessionComponentBuilder;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="function">Session <span class="title">startSession</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> sessionComponentBuilder</div><div class="line">         .sessionModule(<span class="keyword">new</span> SessionModule(…))</div><div class="line">         .build()</div><div class="line">         .session();</div><div class="line">   &#125;</div><div class="line"> &#125;</div><div class="line">	</div><div class="line"> <span class="comment">/**</span></div><div class="line">  * 注入component然后调用其工厂方法. 比上面的方法麻烦	   */</div><div class="line"> <span class="class"><span class="keyword">class</span> <span class="title">SessionStarterInjectingComponent</span> </span>&#123;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> ServerComponent serverComponent;</div><div class="line">   </div><div class="line">   <span class="meta">@Inject</span> SessionStarterInjectingComponent(ServerComponent serverComponent) &#123;</div><div class="line">     <span class="keyword">this</span>.serverComponent = serverComponent;</div><div class="line">   &#125;</div><div class="line">	</div><div class="line">   <span class="function">Session <span class="title">startSession</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> serverComponent.sessionComponentBuilder()</div><div class="line">         .sessionModule(<span class="keyword">new</span> SessionModule(…))</div><div class="line">         .build()</div><div class="line">         .session();</div><div class="line">   &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>注意：SessionStarterInjectingSubcomponentBuilder并不依赖ServerComponent。</p>
<h3 id="Subcomponents-and-scope"><a href="#Subcomponents-and-scope" class="headerlink" title="Subcomponents and scope"></a>Subcomponents and scope</h3><p>将component划分为subcomponent的理由之一是使用<a href="http://docs.oracle.com/javaee/7/api/javax/inject/Scope.html" target="_blank" rel="external">scopes</a>;在普通的没有域的绑定中，一个注入的类型可能每次拿到的是新的独立的实例。但如果这个绑定使用了域，在这个域的生命周期中所有的用户都能拿到同一个实例。</p>
<p>典型的域是<a href="http://docs.oracle.com/javaee/7/api/javax/inject/Singleton.html" target="_blank" rel="external">@Singleton</a>。使用singleton域注解绑定的用户都拿到同一个对象。</p>
<p>Dagger中,可以通过<a href="http://docs.oracle.com/javaee/7/api/javax/inject/Scope.html" target="_blank" rel="external">@Scope</a>注解将component和域联系起来。这种情况下，component的实现持有所有绑定域的对象，所以它们就可以被复用。如果Module中的<a href="http://google.github.io/dagger/api/latest/dagger/Provides.html" target="_blank" rel="external">@Provides</a>方法被一个域注解了，那么这个module只能设置给被同一个域注解的component。</p>
<p>（<a href="http://docs.oracle.com/javaee/7/api/javax/inject/Inject.html" target="_blank" rel="external">@Inject</a>构造器也可以被域注解注解。这些隐式绑定可被其他相同域的component或其后代component使用。被注解的实例将会绑定正确的作用域）。</p>
<p>subcomponent不可以与任何父级component<br>有相同的域，但两个互相独立的subcomponent可以绑定同一个作用域因为不会对哪里保存域对象造成歧义。（即使使用了相同的域注解，这两个subcomponent也拥有不同的域对象。）</p>
<p>例如：在下面的component树中，BadChildComponent拥有和其父亲RootComponent相同的@RootScpe，这是一个错误。但SiblingComponentOne和SiblingComponentTwo可以一起使用@ChildScope，因为不会对两个component中的同类型绑定造成混淆。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RootScope</span> <span class="meta">@Component</span></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">RootComponent</span> </span>&#123;</div><div class="line">  <span class="function">BadChildComponent <span class="title">badChildComponent</span><span class="params">()</span></span>; <span class="comment">// ERROR!</span></div><div class="line">  <span class="function">SiblingComponentOne <span class="title">siblingComponentOne</span><span class="params">()</span></span>;</div><div class="line">  <span class="function">SiblingComponentTwo <span class="title">siblingComponentTwo</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@RootScope</span> <span class="meta">@Subcomponent</span></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">BadChildComponent</span> </span>&#123;…&#125;</div><div class="line"></div><div class="line"><span class="meta">@ChildScope</span> <span class="meta">@Subcomponent</span></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">SiblingComponentOne</span> </span>&#123;…&#125;</div><div class="line"></div><div class="line"><span class="meta">@ChildScope</span> <span class="meta">@Subcomponent</span></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">SiblingComponentTwo</span> </span>&#123;…&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Subcomponents-for-encapsulation"><a href="#Subcomponents-for-encapsulation" class="headerlink" title="Subcomponents for encapsulation"></a>Subcomponents for encapsulation</h3><p>使用subcomponent的另一个原因是将应用的不同部分封装。例如：如果你的服务器中有两个服务（或应用中的两个界面）共享一些绑定，如认证和授权的部分，但它们还有其他与对方没有关系的绑定。为每个服务或界面创建独立的subcomponent将共享的绑定放到parent component,这样就说得通了。在上面的例子中，FooRequestComponent和 BarRequestComponent是隔离的兄弟component。你可以把他们及其module结合到一个@RequestScope component中,但会产生冲突的绑定。</p>
<h3 id="Details"><a href="#Details" class="headerlink" title="Details"></a>Details</h3><h4 id="Extending-multibindings"><a href="#Extending-multibindings" class="headerlink" title="Extending multibindings"></a>Extending multibindings</h4><p>像其他的绑定一样，parent component中的<a href="#multibindings">multibindings</a>对其subcomponent也是可见的。但subcomponent也可以像父component绑定的map和set添加multibinding.其他的这类贡献只对该subcomponent和其子component的绑定可见，对其父component不可见。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span>(modules = ParentModule.class)</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Parent</span> </span>&#123;</div><div class="line">  <span class="function">Map&lt;String, Int&gt; <span class="title">map</span><span class="params">()</span></span>;</div><div class="line">  <span class="function">Set&lt;String&gt; <span class="title">set</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">  <span class="function">Child <span class="title">child</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParentModule</span> </span>&#123;</div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoMap</span></div><div class="line">  <span class="meta">@StringKey</span>(<span class="string">"one"</span>) <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">one</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoMap</span></div><div class="line">  <span class="meta">@StringKey</span>(<span class="string">"two"</span>) <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">two</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">2</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoSet</span></div><div class="line">  <span class="function"><span class="keyword">static</span> String <span class="title">a</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"a"</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoSet</span></div><div class="line">  <span class="function"><span class="keyword">static</span> String <span class="title">b</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"b"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Subcomponent</span>(modules = Child.class)</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Child</span> </span>&#123;</div><div class="line">  <span class="function">Map&lt;String, String&gt; <span class="title">map</span><span class="params">()</span></span>;</div><div class="line">  <span class="function">Set&lt;String&gt; <span class="title">set</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChildModule</span> </span>&#123;</div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoMap</span></div><div class="line">  <span class="meta">@StringKey</span>(<span class="string">"three"</span>) <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">three</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">3</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoMap</span></div><div class="line">  <span class="meta">@StringKey</span>(<span class="string">"four"</span>) <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">four</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">4</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoSet</span></div><div class="line">  <span class="function"><span class="keyword">static</span> String <span class="title">c</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"c"</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Provides</span> <span class="meta">@IntoSet</span></div><div class="line">  <span class="function"><span class="keyword">static</span> String <span class="title">d</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"d"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Parent parent = DaggerParent.create();</div><div class="line">Child child = parent.child();</div><div class="line">assertThat(parent.map().keySet()).containsExactly(<span class="string">"one"</span>, <span class="string">"two"</span>);</div><div class="line">assertThat(child.map().keySet()).containsExactly(<span class="string">"one"</span>, <span class="string">"two"</span>, <span class="string">"three"</span>, <span class="string">"four"</span>);</div><div class="line">assertThat(parent.set()).containsExactly(<span class="string">"a"</span>, <span class="string">"b"</span>);</div><div class="line">assertThat(child.set()).containsExactly(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>);</div></pre></td></tr></table></figure></p>
<h4 id="Repeated-modules"><a href="#Repeated-modules" class="headerlink" title="Repeated modules"></a>Repeated modules</h4><p>component和其任意一个subcomponent都设置了类型的module,那么所有这些component都会使用同一个该module实例。这意味着如果一个subcomponent工厂方法包含一个重复module作为参数或者你使用重复module调用subcomponent建造方法会造成错误。（后者在编译期无法检测，是一个运行时错误）。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span>(modules = &#123;RepeatedModule.class, …&#125;)</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ComponentOne</span> </span>&#123;</div><div class="line">  <span class="function">ComponentTwo <span class="title">componentTwo</span><span class="params">(RepeatedModule repeatedModule)</span></span>; <span class="comment">// COMPILE ERROR!</span></div><div class="line">  ComponentThree.<span class="function">Builder <span class="title">componentThreeBuilder</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Subcomponent</span>(modules = &#123;RepeatedModule.class, …&#125;)</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ComponentTwo</span> </span>&#123; … &#125;</div><div class="line"></div><div class="line"><span class="meta">@Subcomponent</span>(modules = &#123;RepeatedModule.class, …&#125;)</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ComponentThree</span> </span>&#123;</div><div class="line">  <span class="meta">@Subcomponent</span>.Builder</div><div class="line">  <span class="class"><span class="keyword">interface</span> <span class="title">Builder</span> </span>&#123;</div><div class="line">    <span class="function">Builder <span class="title">repeatedModule</span><span class="params">(RepeatedModule repeatedModule)</span></span>;</div><div class="line">    <span class="function">ComponentThree <span class="title">build</span><span class="params">()</span></span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">DaggerComponentOne.create().componentThreeBuilder()</div><div class="line">    .repeatedModule(<span class="keyword">new</span> RepeatedModule()) <span class="comment">// UnsupportedOperationException!</span></div><div class="line">    .build();</div></pre></td></tr></table></figure></p>
<h2 id="Producers"><a href="#Producers" class="headerlink" title="Producers"></a><span id="producers">Producers</span></h2><p>Dagger Producers是一个使用Java实现异步依赖注入的Dagger扩展。</p>
<h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><p>这里假设读者已经熟悉<a href="http://google.github.io/dagger/" target="_blank" rel="external">Dagger2API</a>和Guava的<a href="http://docs.guava-libraries.googlecode.com/git-history/release/javadoc/com/google/common/util/concurrent/ListenableFuture.html" target="_blank" rel="external">ListenableFuture</a>.</p>
<p>Dagger Producers提供了几种新的注解，<a href="http://google.github.io/dagger/api/latest/dagger/producers/ProducerModule.html" target="_blank" rel="external">@ProducerModule</a>，<a href="http://google.github.io/dagger/api/latest/dagger/producers/Produces.html" target="_blank" rel="external">@Producers</a>和<a href="http://google.github.io/dagger/api/latest/dagger/producers/ProductionComponent.html" target="_blank" rel="external">@ProductionComponent</a>分别类比<a href="http://google.github.io/dagger/api/latest/dagger/Module.html" target="_blank" rel="external">@Module</a>,<a href="http://google.github.io/dagger/api/latest/dagger/Provides.html" target="_blank" rel="external">@Provides</a>和<a href="http://google.github.io/dagger/api/latest/dagger/Component.html" target="_blank" rel="external">@Component</a>.我们把@ProducerModule注解的类作为<strong>producer modules</strong>,@Produces注解的方法作为<strong>producer methods</strong>,@ProductionComponent注解的接口作为<strong>producer graphs</strong>(类比于<strong>modules,provider methods</strong>,和<strong>object graphs</strong>).</p>
<p>并发编程是一个难题，但是一个强大而简单的抽象可以显著的简化并发的编写。出于这样的考虑，Guava 定义了 ListenableFuture接口并继承了JDK concurrent包下的Future 接口。</p>
<p>所以我没有继续翻译这篇文档。详情点击<a href="http://ifeve.com/google-guava-listenablefuture/" target="_blank" rel="external">ListenableFuture</a>，详情点击<a href="http://google.github.io/dagger/producers.html" target="_blank" rel="external">Producers</a>。</p>
<h2 id="Testing"><a href="#Testing" class="headerlink" title="Testing"></a><span id="testing">Testing</span></h2><p>使用依赖注入框架会使测试变得更简单。本文档中探索了一些测试使用了Dagger的应用的策略。</p>
<h3 id="Don’t-use-Dagger-for-unit-testing"><a href="#Don’t-use-Dagger-for-unit-testing" class="headerlink" title="Don’t use Dagger for unit testing"></a>Don’t use Dagger for unit testing</h3><p>如果你想写一个小的单元测试测试一个@Inject注解的类，不需要在测试代码中使用Dagger,只需调用@Inject注解的构造器和方法并设置给@Inject注解的字段即可，也可以直接传入模拟的依赖对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ThingDoer</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ThingGetter getter;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ThingPutter putter;</div><div class="line"></div><div class="line">  <span class="meta">@Inject</span> ThingDoer(ThingGetter getter, ThingPutter putter) &#123;</div><div class="line">    <span class="keyword">this</span>.getter = getter;</div><div class="line">    <span class="keyword">this</span>.putter = putter;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function">String <span class="title">doTheThing</span><span class="params">(<span class="keyword">int</span> howManyTimes)</span> </span>&#123; <span class="comment">/* … */</span> &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThingDoerTest</span> </span>&#123;</div><div class="line">  <span class="meta">@Test</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDoTheThing</span><span class="params">()</span> </span>&#123;</div><div class="line">    ThingDoer doer = <span class="keyword">new</span> ThingDoer(fakeGetter, fakePutter);</div><div class="line">    assertEquals(<span class="string">"done"</span>, doer.doTheThing(<span class="number">5</span>));</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Replace-bindings-for-functional-integration-end-to-end-testing"><a href="#Replace-bindings-for-functional-integration-end-to-end-testing" class="headerlink" title="Replace bindings for functional/integration/end-to-end testing"></a>Replace bindings for functional/integration/end-to-end testing</h3><p>功能测试/综合测试/端对端测试一般使用生产环境的应用，但使用<a href="">fakes</a>替换persistence，后端和验证系统，让其他部分正常运行。这种方式适用于一个或少量有限数量的测试配置替换产品配置中的一些绑定。</p>
<h4 id="Option-1-Override-bindings-by-subclassing-modules-don’t-do-this"><a href="#Option-1-Override-bindings-by-subclassing-modules-don’t-do-this" class="headerlink" title="Option 1: Override bindings by subclassing modules (don’t do this!)"></a>Option 1: Override bindings by subclassing modules (don’t do this!)</h4><p>最简单的方法是通过子类重写module的@Provides方法来替换待测component中的绑定。（看<a href="#do-not-override">下面</a>会出现的问题）.</p>
<p>当创建Dagger component的实例时，你传入需要的module实例。你可以这些module子类实例，这些子类可以重写module中的@Provides方法来替换一些绑定。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span>(modules = &#123;AuthModule.class, <span class="comment">/* … */</span>&#125;)</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">MyApplicationComponent</span> </span>&#123; <span class="comment">/* … */</span> &#125;</div><div class="line"></div><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthModule</span> </span>&#123;</div><div class="line">  <span class="meta">@Provides</span> <span class="function">AuthManager <span class="title">authManager</span><span class="params">(AuthManagerImpl impl)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> impl;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FakeAuthModule</span> <span class="keyword">extends</span> <span class="title">AuthModule</span> </span>&#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function">AuthManager <span class="title">authManager</span><span class="params">(AuthManagerImpl impl)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FakeAuthManager();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">MyApplicationComponent testingComponent = DaggerMyApplicationComponent.builder()</div><div class="line">    .authModule(<span class="keyword">new</span> FakeAuthModule())</div><div class="line">    .build();</div></pre></td></tr></table></figure></p>
<p><span id="do-not-override">但这种方法也有一些局限性</span>：</p>
<ul>
<li>不能改变绑定图的静态图形：不能添加或移除绑定或改变绑定的依赖。具体讲：<ul>
<li>重写@Provides方法不能改变其参数类型，缩小返回类型的范围也不会对绑定图造成影响。上面的例子中，testingComponent扔需要为AuthManagerImpl绑定以及其他的依赖，即使它们没有被用到。</li>
<li>同样地，重写的module不能添加绑定到对象图，包括<a href="#multibindings">multibinding</a>(但你仍可以重写一个SET_VALUES方法来返回一个不同的set)。任何子类中新的@Provides方法都会被Dagger忽略。这意味着虚拟的对象几乎不能使用到依赖注入的优势。</li>
</ul>
</li>
<li>这种方式复写的@Provides方法不能是静态的，所以不能<a href="https://github.com/google/dagger/commit/9b81e1091d5e9ddd1e84318fbab863a8c62fb757" target="_blank" rel="external">省略</a>它们的实例。</li>
</ul>
<h4 id="Option-2-Separate-component-configurations"><a href="#Option-2-Separate-component-configurations" class="headerlink" title="Option 2: Separate component configurations"></a><span id="separate-component-configurations">Option 2: Separate component configurations</span></h4><p>另一个方法需要对module进行更多的前期设计。应用的每个配置（生产和测试）使用不同的component配置。这个测试component类型继承了生产环境component并配置了不同的modules.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span>(modules = &#123;</div><div class="line">  OAuthModule.class, <span class="comment">// real auth</span></div><div class="line">  FooServiceModule.class, <span class="comment">// real backend</span></div><div class="line">  OtherApplicationModule.class,</div><div class="line">  <span class="comment">/* … */</span> &#125;)</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ProductionComponent</span> </span>&#123;</div><div class="line">  <span class="function">Server <span class="title">server</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Component</span>(modules = &#123;</div><div class="line">  FakeAuthModule.class, <span class="comment">// fake auth</span></div><div class="line">  FakeFooServiceModule.class, <span class="comment">// fake backend</span></div><div class="line">  OtherApplicationModule.class,</div><div class="line">  <span class="comment">/* … */</span>&#125;)</div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">TestComponent</span> <span class="keyword">extends</span> <span class="title">ProductionComponent</span> </span>&#123;</div><div class="line">  <span class="function">FakeAuthManager <span class="title">fakeAuthManager</span><span class="params">()</span></span>;</div><div class="line">  <span class="function">FakeFooService <span class="title">fakeFooService</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在测试调用的主方法是DaggerTestComponent.builder()而不是DaggerProductionComponent.builder().注意此test component接口可以添加虚拟实例（fakeAuthManager()和fakeFooService()）句柄这样需要的时候就可以拿到它们控制线束。    </p>
<p>但你会怎样设计你的modules让这个模式更简单呢？</p>
<h3 id="Organize-modules-for-testability"><a href="#Organize-modules-for-testability" class="headerlink" title="Organize modules for testability"></a>Organize modules for testability</h3><p>Module类是一种<a href="https://en.wikipedia.org/wiki/Utility_class" target="_blank" rel="external">工具类</a>：是包含很多@Provides方法的集合，每个@Provides方法都可以作为一个注入器提供指定类型实例。</p>
<p>(一个@Provides方法依赖另一个提供的类型会使几个@Provides方法产生联系，但通常它们不会明确地调用对方或依赖同一可变状态。多个@Provides方法指向同一实例字段，这样它们就不再是独立的了。这里的建议是将@Provides方法视为工具方法这样测试时更易替换module)。</p>
<p>那么怎么决定哪些@Provides方法应该放在一个module中呢？</p>
<p>一种方式是将bindings分为published bindings和internal bindings，然后再决定那些published bindings有合适的选择。</p>
<p><strong>Published</strong> bindings（公有绑定）    是这些向应用的其他部分提供功能的绑定。如AuthManager 或 User 或 DocDatabase 都是 published：他们都绑定在一个module中这样应用其他部分就可以使用他们。</p>
<p>剩下的绑定就是<strong>Internal</strong>（私有绑定） bindings：这类绑定在一些published 类型的实现中作为一部分被使用。例如：OAuth client ID或OAuthKeyStore的配置绑定只会被OAuth的实现AuthManager使用，不会被应用的其他部分使用。这些绑定通常是package-private的或被package-private修饰。</p>
<p>一些published 绑定会有替代选择，特别是测试时，其他的就没有。例如：AuthManager就有可选绑定：一个测试用，其他适用于不同的授权/验证协议。</p>
<p>但另一方面，如果AuthManager接口有一个方法返回当前在线用户，你可能想发布一个绑定提供Users，仅通过调用AuthManager的getCurrentUser()即可。这个published绑定就不太可能需要替代了。</p>
<p>一旦你将绑定分为带有替代选择的published绑定、没有替代选择的published绑定和internal绑定，可以这样编排modules:</p>
<ul>
<li>每个带替代选择的published绑定对应一个module。（每一个替代选择也对应一个module。）这个module仅包含一个published绑定，以及所有这个published 绑定需要的internal 绑定。</li>
<li>所有无替代选择的published bindings放入按照功能线组织的module中</li>
<li>公有绑定module应该包含需要公有绑定的没有替代选择的module.</li>
</ul>
<p>为每个module加上文档描述它提供的公有绑定自然是极好的。</p>
<p>这是使用auth domain的例子。如果有一个AuthManager接口，它可能有一个OAuth实现和一个测试用的模拟实现。综上所述，可能有一个你并不像改变配置的关于当前用户的绑定。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Provides auth bindings that will not change in different auth configurations,</div><div class="line"> * such as the current user.</div><div class="line"> */</div><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthModule</span> </span>&#123;</div><div class="line">  <span class="meta">@Provides</span> <span class="function"><span class="keyword">static</span> User <span class="title">currentUser</span><span class="params">(AuthManager authManager)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> authManager.currentUser();</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// Other bindings that don’t differ among AuthManager implementations.</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/** Provides a &#123;<span class="doctag">@link</span> AuthManager&#125; that uses OAuth. */</span></div><div class="line"><span class="meta">@Module</span>(includes = AuthModule.class) <span class="comment">// Include no-alternative bindings.</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">OAuthModule</span> </span>&#123;</div><div class="line">  <span class="meta">@Provides</span> <span class="function"><span class="keyword">static</span> AuthManager <span class="title">authManager</span><span class="params">(OAuthManager authManager)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> authManager;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// Other bindings used only by OAuthManager.</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/** Provides a fake &#123;<span class="doctag">@link</span> AuthManager&#125; for testing. */</span></div><div class="line"><span class="meta">@Module</span>(includes = AuthModule.class) <span class="comment">// Include no-alternative bindings.</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FakeAuthModule</span> </span>&#123;</div><div class="line">  <span class="meta">@Provides</span> <span class="function"><span class="keyword">static</span> AuthManager <span class="title">authManager</span><span class="params">(FakeAuthManager authManager)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> authManager;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// Other bindings used only by FakeAuthManager.</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后你的正式环境配置将会使用真正的module，和测试配置使用虚拟module，如<a href="#separate-component-configurations">上</a>所述。  </p>
<h2 id="Project-Pages"><a href="#Project-Pages" class="headerlink" title="Project Pages"></a><span id="project">Project Pages</span></h2><p><a href="https://github.com/google/dagger" target="_blank" rel="external">GitHub</a><br><a href="http://google.github.io/dagger/api/2.0/" target="_blank" rel="external">Release 2.0 API(javadoc)</a><br><a href="http://google.github.io/dagger/api/latest/" target="_blank" rel="external">Developer API(javadoc)</a></p>
<p><strong>因为官方工程是基于maven构建的，为了便于各位Android Coder的学习，我将官方工程中Android的部分拿出来放到<a href="https://github.com/Metal626/Dagger2ForAndroid.git" target="_blank" rel="external">GitHub</a>上了。</strong></p>
<p><span id="bottom"><a href="#top">回到顶部</a></span></p>

      
    </div>

    <div>
      
        
<div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/uploads/wechat-qcode.jpg" alt="Metal626 wechat" style="width: 200px; max-width: 100%;"/>
    <div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div>
</div>


      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android/" rel="tag"># android</a>
          
            <a href="/tags/依赖注入/" rel="tag"># 依赖注入</a>
          
            <a href="/tags/dagger2/" rel="tag"># dagger2</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/11/29/apk瘦身/" rel="next" title="apk瘦身的几个技巧 - Optimize your app">
                <i class="fa fa-chevron-left"></i> apk瘦身的几个技巧 - Optimize your app
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/12/12/jenkins+gitlab+蒲公英实现android应用自动化打包分发/" rel="prev" title="jenkins+gitlab+蒲公英实现android应用自动化打包分发">
                jenkins+gitlab+蒲公英实现android应用自动化打包分发 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/11/29/dagger2文档翻译/"
           data-title="依赖注入框架Dagger2系统性学习" data-url="http://yoursite.com/2016/11/29/dagger2文档翻译/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Metal626" />
          <p class="site-author-name" itemprop="name">Metal626</p>
          <p class="site-description motion-element" itemprop="description">Learning is a gift , even when pain is your teacher.</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">9</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Metal626" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/3049110975" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/victheo" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/users/ff6ebd9b5d53/latest_articles" target="_blank" title="简书">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  简书
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Home"><span class="nav-number">1.</span> <span class="nav-text">Home</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#文档"><span class="nav-number">1.1.</span> <span class="nav-text">文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码"><span class="nav-number">1.2.</span> <span class="nav-text">代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#有问题？"><span class="nav-number">1.3.</span> <span class="nav-text">有问题？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#User’s-Guide"><span class="nav-number">2.</span> <span class="nav-text">User’s Guide</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Dagger2的亮点"><span class="nav-number">2.1.</span> <span class="nav-text">Dagger2的亮点 </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Using-Dagger"><span class="nav-number">2.2.</span> <span class="nav-text">Using Dagger</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#声明依赖"><span class="nav-number">2.2.1.</span> <span class="nav-text">声明依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实现依赖"><span class="nav-number">2.2.2.</span> <span class="nav-text">实现依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#建立对象图"><span class="nav-number">2.2.3.</span> <span class="nav-text">建立对象图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#单例和域绑定"><span class="nav-number">2.2.4.</span> <span class="nav-text">单例和域绑定</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#可重用的scope"><span class="nav-number">2.2.5.</span> <span class="nav-text">可重用的scope</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#延迟注入"><span class="nav-number">2.2.6.</span> <span class="nav-text">延迟注入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Provider注入"><span class="nav-number">2.2.7.</span> <span class="nav-text">Provider注入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Qualifiers"><span class="nav-number">2.2.8.</span> <span class="nav-text">Qualifiers</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编译期校验"><span class="nav-number">2.2.9.</span> <span class="nav-text">编译期校验</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Using-Dagger-In-Your-Build"><span class="nav-number">2.3.</span> <span class="nav-text">Using Dagger In Your Build</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Gradle-Users"><span class="nav-number">2.3.1.</span> <span class="nav-text">Gradle Users</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dagger-amp-Android"><span class="nav-number">3.</span> <span class="nav-text">Dagger&Android</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#原理（Philosophy）"><span class="nav-number">3.1.</span> <span class="nav-text">原理（Philosophy）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多重绑定-Multibindings"><span class="nav-number">4.</span> <span class="nav-text">多重绑定(Multibindings)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Set-multibindings"><span class="nav-number">4.1.</span> <span class="nav-text">Set multibindings</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Map-multibindings"><span class="nav-number">4.1.1.</span> <span class="nav-text">Map multibindings</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Simple-map-keys"><span class="nav-number">4.1.1.1.</span> <span class="nav-text">Simple map keys</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Complex-map-keys"><span class="nav-number">4.1.1.2.</span> <span class="nav-text">Complex map keys</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Maps-whose-keys-are-not-known-at-compile-time"><span class="nav-number">4.1.1.3.</span> <span class="nav-text">Maps whose keys are not known at compile time</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Declaring-multibindings"><span class="nav-number">4.1.2.</span> <span class="nav-text">Declaring multibindings</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Alternative-ElementsIntoSet-returning-an-empty-set"><span class="nav-number">4.1.2.1.</span> <span class="nav-text">Alternative: @ElementsIntoSet returning an empty set</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Inherited-subcomponent-multibindings"><span class="nav-number">4.1.3.</span> <span class="nav-text">Inherited subcomponent multibindings</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Subcomponents"><span class="nav-number">5.</span> <span class="nav-text">Subcomponents</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Declaring-a-subcomponent"><span class="nav-number">5.1.</span> <span class="nav-text">Declaring a subcomponent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Adding-a-subcomponent-to-a-parent-component"><span class="nav-number">5.2.</span> <span class="nav-text">Adding a subcomponent to a parent component</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Subcomponent-builders"><span class="nav-number">5.3.</span> <span class="nav-text">Subcomponent builders</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Subcomponents-and-scope"><span class="nav-number">5.4.</span> <span class="nav-text">Subcomponents and scope</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Subcomponents-for-encapsulation"><span class="nav-number">5.5.</span> <span class="nav-text">Subcomponents for encapsulation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Details"><span class="nav-number">5.6.</span> <span class="nav-text">Details</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Extending-multibindings"><span class="nav-number">5.6.1.</span> <span class="nav-text">Extending multibindings</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Repeated-modules"><span class="nav-number">5.6.2.</span> <span class="nav-text">Repeated modules</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Producers"><span class="nav-number">6.</span> <span class="nav-text">Producers</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Overview"><span class="nav-number">6.1.</span> <span class="nav-text">Overview</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Testing"><span class="nav-number">7.</span> <span class="nav-text">Testing</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Don’t-use-Dagger-for-unit-testing"><span class="nav-number">7.1.</span> <span class="nav-text">Don’t use Dagger for unit testing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Replace-bindings-for-functional-integration-end-to-end-testing"><span class="nav-number">7.2.</span> <span class="nav-text">Replace bindings for functional/integration/end-to-end testing</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Option-1-Override-bindings-by-subclassing-modules-don’t-do-this"><span class="nav-number">7.2.1.</span> <span class="nav-text">Option 1: Override bindings by subclassing modules (don’t do this!)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Option-2-Separate-component-configurations"><span class="nav-number">7.2.2.</span> <span class="nav-text">Option 2: Separate component configurations</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Organize-modules-for-testability"><span class="nav-number">7.3.</span> <span class="nav-text">Organize modules for testability</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Project-Pages"><span class="nav-number">8.</span> <span class="nav-text">Project Pages</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016-11 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Metal626</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"Metal626"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  








  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("Y8y93MXpcqOE9wb5HAQs6lqf-gzGzoHsz", "YdeEwg5y5si4gx2QxCN6qjPe");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  


</body>
</html>
