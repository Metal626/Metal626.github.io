<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="子质’s Notes" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="Learning is a gift , even when pain is your teacher.">
<meta property="og:type" content="website">
<meta property="og:title" content="子质’s Notes">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="子质’s Notes">
<meta property="og:description" content="Learning is a gift , even when pain is your teacher.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="子质’s Notes">
<meta name="twitter:description" content="Learning is a gift , even when pain is your teacher.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title> 子质’s Notes </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?6f9256e19b7a628fa2646bc35feb03de";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">子质’s Notes</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/13/how_to_npm/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="子质">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="子质’s Notes">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="子质’s Notes" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/13/how_to_npm/" itemprop="url">
                  How  to  npm
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-13T13:58:26+08:00">
                2017-10-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/node-js/" itemprop="url" rel="index">
                    <span itemprop="name">node.js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/10/13/how_to_npm/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/10/13/how_to_npm/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/10/13/how_to_npm/" class="leancloud_visitors" data-flag-title="How  to  npm">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Dev-Environment"><a href="#Dev-Environment" class="headerlink" title="Dev Environment"></a>Dev Environment</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm init  创建package.json  初始化工程</div></pre></td></tr></table></figure>
<h3 id="Login"><a href="#Login" class="headerlink" title="Login"></a>Login</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">npm whoami  查看当前账户</div><div class="line">npm adduser	创建账户</div></pre></td></tr></table></figure>
<h3 id="Start-A-Project"><a href="#Start-A-Project" class="headerlink" title="Start A Project"></a>Start A Project</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm init --scope=&lt;username&gt;	替换username为你的账户</div></pre></td></tr></table></figure>
<h3 id="Install-A-Module"><a href="#Install-A-Module" class="headerlink" title="Install A Module"></a>Install A Module</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install &lt;modulename&gt;</div></pre></td></tr></table></figure>
<h3 id="Listing-Dependencies"><a href="#Listing-Dependencies" class="headerlink" title="Listing Dependencies"></a>Listing Dependencies</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm ls</div></pre></td></tr></table></figure>
<h3 id="npm-Test"><a href="#npm-Test" class="headerlink" title="npm Test"></a>npm Test</h3><p>创建test.js并配置package.json</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&quot;scripts&quot;: &#123;</div><div class="line">        &quot;test&quot;: &quot;node test.js&quot;</div><div class="line">      &#125;</div></pre></td></tr></table></figure>
<h3 id="Package-Niceties"><a href="#Package-Niceties" class="headerlink" title="Package Niceties"></a>Package Niceties</h3><p>创建README.md<br>在package.json中添加字段’repository’，description.</p>
<h3 id="Publish"><a href="#Publish" class="headerlink" title="Publish"></a>Publish</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm publish 将module发布到registry</div></pre></td></tr></table></figure>
<h3 id="Version"><a href="#Version" class="headerlink" title="Version"></a>Version</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm version</div></pre></td></tr></table></figure>
<h3 id="Publish-Again"><a href="#Publish-Again" class="headerlink" title="Publish Again"></a>Publish Again</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">更新版本号后</div><div class="line">执行npm publish</div></pre></td></tr></table></figure>
<h3 id="Dist-Tag"><a href="#Dist-Tag" class="headerlink" title="Dist Tag"></a>Dist Tag</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm dist-tag add pkg@version [&lt;tag&gt;]</div></pre></td></tr></table></figure>
<h3 id="Dist-Tag-Removal"><a href="#Dist-Tag-Removal" class="headerlink" title="Dist Tag Removal"></a>Dist Tag Removal</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm dist-tag rm pkg  [&lt;tag&gt;]</div></pre></td></tr></table></figure>
<h3 id="Outdated"><a href="#Outdated" class="headerlink" title="Outdated"></a>Outdated</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm outdated</div></pre></td></tr></table></figure>
<h3 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm update</div></pre></td></tr></table></figure>
<h3 id="Rm"><a href="#Rm" class="headerlink" title="Rm"></a>Rm</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm rm pkg@version --save</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/11/learnyounode/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="子质">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="子质’s Notes">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="子质’s Notes" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/11/learnyounode/" itemprop="url">
                  Learning Node.js
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-11T16:03:54+08:00">
                2017-10-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/node-js/" itemprop="url" rel="index">
                    <span itemprop="name">node.js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/10/11/learnyounode/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/10/11/learnyounode/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/10/11/learnyounode/" class="leancloud_visitors" data-flag-title="Learning Node.js">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="HELLO-WORLD-Exercise-1-of-13"><a href="#HELLO-WORLD-Exercise-1-of-13" class="headerlink" title="HELLO WORLD (Exercise 1 of 13)"></a>HELLO WORLD (Exercise 1 of 13)</h3><p>  Write a program that prints the text “HELLO WORLD” to the console<br>  (stdout).<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">console.log(&quot;HELLO WORLD&quot;)</div></pre></td></tr></table></figure></p>
<h3 id="BABY-STEPS-Exercise-2-of-13"><a href="#BABY-STEPS-Exercise-2-of-13" class="headerlink" title="BABY STEPS (Exercise 2 of 13)"></a>BABY STEPS (Exercise 2 of 13)</h3><p>  Write a program that accepts one or more numbers as command-line arguments<br>  and prints the sum of those numbers to the console (stdout). </p>
<figure class="highlight irpf90"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">let <span class="built_in">sum</span> = <span class="number">0</span></div><div class="line"></div><div class="line">process.argv.forEach((item,<span class="built_in">index</span>) =&gt; &#123;</div><div class="line">    <span class="keyword">if</span>(<span class="built_in">index</span>&gt;<span class="number">1</span>)</div><div class="line">        <span class="built_in">sum</span>+=<span class="keyword">Number</span>(item)</div><div class="line">&#125;);</div><div class="line">console.<span class="built_in">log</span>(<span class="built_in">sum</span>)</div></pre></td></tr></table></figure>
<h3 id="MY-FIRST-I-O-Exercise-3-of-13"><a href="#MY-FIRST-I-O-Exercise-3-of-13" class="headerlink" title="MY FIRST I/O! (Exercise 3 of 13)"></a>MY FIRST I/O! (Exercise 3 of 13)</h3><p>  Write a program that uses a single synchronous filesystem operation to<br>  read a file and print the number of newlines (\n) it contains to the<br>  console (stdout), similar to running cat file | wc -l.</p>
<p>  The full path to the file to read will be provided as the first<br>  command-line argument (i.e., process.argv[2]). You do not need to make<br>  your own test file.<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">  let fs = require(&quot;fs&quot;)</div><div class="line"></div><div class="line">let data = fs.readFileSync(process.argv[2],&quot;utf-8&quot;);</div><div class="line">console.log(data.split(&quot;\n&quot;).length -1);</div></pre></td></tr></table></figure></p>
<h3 id="MY-FIRST-ASYNC-I-O-Exercise-4-of-13"><a href="#MY-FIRST-ASYNC-I-O-Exercise-4-of-13" class="headerlink" title="MY FIRST ASYNC I/O! (Exercise 4 of 13)"></a>MY FIRST ASYNC I/O! (Exercise 4 of 13)</h3><p>  Write a program that uses a single asynchronous filesystem operation to<br>  read a file and print the number of newlines it contains to the console<br>  (stdout), similar to running cat file | wc -l.</p>
<p>  The full path to the file to read will be provided as the first<br>  command-line argument.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">var fs = require(&quot;fs&quot;)</div><div class="line"></div><div class="line">fs.readFile(process.argv[2],&quot;utf-8&quot;,(err,data) =&gt; &#123;</div><div class="line">    let newlines = 0</div><div class="line">    if(err) console.error(err)</div><div class="line">    for (let codepoint of data)&#123;</div><div class="line"></div><div class="line">        if(codepoint===&quot;\n&quot;)</div><div class="line">            newlines++;</div><div class="line">    &#125;</div><div class="line">    console.log(newlines)</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h3 id="FILTERED-LS-Exercise-5-of-13"><a href="#FILTERED-LS-Exercise-5-of-13" class="headerlink" title="FILTERED LS (Exercise 5 of 13)"></a>FILTERED LS (Exercise 5 of 13)</h3><p>  Create a program that prints a list of files in a given directory,<br>  filtered by the extension of the files. You will be provided a directory<br>  name as the first argument to your program (e.g. ‘/path/to/dir/‘) and a<br>  file extension to filter by as the second argument.</p>
<p>  For example, if you get ‘txt’ as the second argument then you will need to<br>  filter the list to only files that end with .txt. Note that the second<br>  argument will not come prefixed with a ‘.’.</p>
<p>  Keep in mind that the first arguments of your program are not the first<br>  values of the process.argv array, as the first two values are reserved for<br>  system info by Node.</p>
<p>  The list of files should be printed to the console, one file per line. You<br>  must use asynchronous I/O.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">let fs = require(&quot;fs&quot;)</div><div class="line"></div><div class="line">fs.readdir(process.argv[2], (err, list) =&gt; &#123;</div><div class="line">    if (err) return console.error(err)</div><div class="line">    list.forEach((item) =&gt; &#123;</div><div class="line">        if (item.endsWith(&quot;.&quot; + process.argv[3]))</div><div class="line">            console.log(item)</div><div class="line">    &#125;)</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h3 id="MAKE-IT-MODULAR-Exercise-6-of-13"><a href="#MAKE-IT-MODULAR-Exercise-6-of-13" class="headerlink" title="MAKE IT MODULAR (Exercise 6 of 13)"></a>MAKE IT MODULAR (Exercise 6 of 13)</h3><p>  This problem is the same as the previous but introduces the concept of<br>  modules. You will need to create two files to solve this.</p>
<p>  Create a program that prints a list of files in a given directory,<br>  filtered by the extension of the files. The first argument is the<br>  directory name and the second argument is the extension filter. Print the<br>  list of files (one file per line) to the console. You must use<br>  asynchronous I/O.</p>
<p>  You must write a module file to do most of the work. The module must<br>  export a single function that takes three arguments: the directory name,<br>  the filename extension string and a callback function, in that order. The<br>  filename extension argument must be the same as what was passed to your<br>  program. Don’t turn it into a RegExp or prefix with “.” or do anything<br>  except pass it to your module where you can do what you need to make your<br>  filter work.</p>
<p>  The callback function must be called using the idiomatic node(err, data)<br>  convention. This convention stipulates that unless there’s an error, the<br>  first argument passed to the callback will be null, and the second will be<br>  your data. In this exercise, the data will be your filtered list of files,<br>  as an Array. If you receive an error, e.g. from your call to<br>  fs.readdir(), the callback must be called with the error, and only the<br>  error, as the first argument.</p>
<p>  You must not print directly to the console from your module file, only<br>  from your original program.</p>
<p>  In the case of an error bubbling up to your original program file, simply<br>  check for it and print an informative message to the console.</p>
<p>  These four things are the contract that your module must follow.</p>
<ol>
<li>Export a single function that takes exactly the arguments described.</li>
<li>Call the callback exactly once with an error or some data as described.</li>
<li>Don’t change anything else, like global variables or stdout.</li>
<li>Handle all the errors that may occur and pass them to the callback.</li>
</ol>
<p>The benefit of having a contract is that your module can be used by anyone<br>who expects this contract. So your module could be used by anyone else who<br>does learnyounode, or the verifier, and just work.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">let fs = require(&quot;fs&quot;)</div><div class="line"></div><div class="line">module.exports =  function foo(dir,ext,callback) &#123;</div><div class="line">    fs.readdir(dir, (err, data) =&gt; &#123;</div><div class="line">        if(err)  return callback(err)</div><div class="line">        let list = []</div><div class="line">        data.forEach((item) =&gt; &#123;</div><div class="line">            if (item.endsWith(&quot;.&quot; + ext))</div><div class="line">                list.push(item)</div><div class="line">        &#125;)</div><div class="line">        callback(null,list)</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">let foo = require(&apos;./module2.js&apos;);</div><div class="line"></div><div class="line">foo(process.argv[2],process.argv[3],(err,data) =&gt;&#123;</div><div class="line">    if(err)</div><div class="line">        return console.error(err)</div><div class="line">    data.forEach((item)=&gt;&#123;</div><div class="line">        console.log(item)</div><div class="line">    &#125;)</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="HTTP-CLIENT-Exercise-7-of-13"><a href="#HTTP-CLIENT-Exercise-7-of-13" class="headerlink" title="HTTP CLIENT (Exercise 7 of 13)"></a>HTTP CLIENT (Exercise 7 of 13)</h3><p> Write a program that performs an HTTP GET request to a URL provided to you<br>  as the first command-line argument. Write the String contents of each<br>  “data” event from the response to a new line on the console (stdout).<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">  let http = require(&apos;http&apos;)</div><div class="line"></div><div class="line">http.get(process.argv[2],(res)=&gt;&#123;</div><div class="line">    res.setEncoding(&apos;utf-8&apos;)</div><div class="line">    res.on(&apos;error&apos;,(error)=&gt;&#123;</div><div class="line">        return console.error(error)</div><div class="line">    &#125;)</div><div class="line">    res.on(&quot;data&quot;,(data)=&gt;&#123;</div><div class="line">        console.log(data)</div><div class="line">    &#125;)</div><div class="line">&#125;).on(&quot;error&quot;,console.error)</div></pre></td></tr></table></figure></p>
<h3 id="HTTP-COLLECT-Exercise-8-of-13"><a href="#HTTP-COLLECT-Exercise-8-of-13" class="headerlink" title="HTTP COLLECT (Exercise 8 of 13)"></a>HTTP COLLECT (Exercise 8 of 13)</h3><p> Write a program that performs an HTTP GET request to a URL provided to you<br>  as the first command-line argument. Collect all data from the server (not<br>  just the first “data” event) and then write two lines to the console<br>  (stdout).</p>
<p>  The first line you write should just be an integer representing the number<br>  of characters received from the server. The second line should contain the<br>  complete String of characters sent by the server.<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">  let http = require(&quot;http&quot;)</div><div class="line">let concatstream = require(&quot;concat-stream&quot;)</div><div class="line"></div><div class="line">http.get(process.argv[2], (res) =&gt; &#123;</div><div class="line"></div><div class="line">    res.on(&quot;error&quot;, console.error)</div><div class="line">    res.on(&quot;data&quot;, (data) =&gt; &#123;</div><div class="line"></div><div class="line">    &#125;)</div><div class="line">    res.pipe(concatstream((data) =&gt; &#123;</div><div class="line">        console.log(data.toString().length)</div><div class="line">        console.log(data.toString())</div><div class="line">    &#125;))</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<h3 id="JUGGLING-ASYNC-Exercise-9-of-13"><a href="#JUGGLING-ASYNC-Exercise-9-of-13" class="headerlink" title="JUGGLING ASYNC (Exercise 9 of 13)"></a>JUGGLING ASYNC (Exercise 9 of 13)</h3><p> This problem is the same as the previous problem (HTTP COLLECT) in that<br>  you need to use http.get(). However, this time you will be provided with<br>  three URLs as the first three command-line arguments.</p>
<p>  You must collect the complete content provided to you by each of the URLs<br>  and print it to the console (stdout). You don’t need to print out the<br>  length, just the data as a String; one line per URL. The catch is that you<br>  must print them out in the same order as the URLs are provided to you as<br>  command-line arguments.  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">let http = require(&apos;http&apos;)</div><div class="line"></div><div class="line">const list = []</div><div class="line">list.push(process.argv[2])</div><div class="line">list.push(process.argv[3])</div><div class="line">list.push(process.argv[4])</div><div class="line">const data = []</div><div class="line"></div><div class="line"></div><div class="line">function fetch(url, callback) &#123;</div><div class="line">    http.get(url, res =&gt; &#123;</div><div class="line">        let buff = []</div><div class="line">        res.on(&quot;data&quot;, data =&gt; &#123;</div><div class="line">            buff += data</div><div class="line">        &#125;)</div><div class="line">        res.on(&quot;end&quot;, () =&gt; &#123;</div><div class="line">            data.push(buff.toString())</div><div class="line">            callback()</div><div class="line">        &#125;)</div><div class="line">    &#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line">fetch(list[0], () =&gt; &#123;</div><div class="line">    fetch(list[1], () =&gt; &#123;</div><div class="line">        fetch(list[2], () =&gt; &#123;</div><div class="line">            data.forEach(item =&gt; &#123;</div><div class="line">                console.log(item)</div><div class="line">            &#125;)</div><div class="line">        &#125;)</div><div class="line">    &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h3 id="TIME-SERVER-Exercise-10-of-13"><a href="#TIME-SERVER-Exercise-10-of-13" class="headerlink" title="TIME SERVER (Exercise 10 of 13)"></a>TIME SERVER (Exercise 10 of 13)</h3><p> Write a TCP time server!</p>
<p> Your server should listen to TCP connections on the port provided by the<br> first argument to your program. For each connection you must write the<br> current date &amp; 24 hour time in the format:</p>
<pre><code>&quot;YYYY-MM-DD hh:mm&quot;
</code></pre><p> followed by a newline character. Month, day, hour and minute must be<br> zero-filled to 2 integers. For example:</p>
<pre><code>&quot;2013-07-06 17:42&quot;
</code></pre><p> After sending the string, close the connection.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">let net = require(&apos;net&apos;)</div><div class="line"></div><div class="line">net.createServer(socket =&gt; &#123;</div><div class="line">    let date = new Date()</div><div class="line">    &quot;x&quot;.padStart(3, &quot;0&quot;)</div><div class="line">    socket.end(date.getFullYear() + &quot;-&quot; + ((date.getMonth() + 1).toString().padStart(2, &quot;0&quot;))</div><div class="line">        + &quot;-&quot; + (date.getDate().toString().padStart(2, &quot;0&quot;)) + &quot; &quot; + date.getHours() + &quot;:&quot; + date.getMinutes()+&quot;\n&quot;)</div><div class="line">&#125;).listen(process.argv[2])</div></pre></td></tr></table></figure></p>
<h3 id="HTTP-FILE-SERVER-Exercise-11-of-13"><a href="#HTTP-FILE-SERVER-Exercise-11-of-13" class="headerlink" title="HTTP FILE SERVER (Exercise 11 of 13)"></a>HTTP FILE SERVER (Exercise 11 of 13)</h3><p>Write an HTTP server that serves the same text file for each request it<br>receives.</p>
<p>Your server should listen on the port provided by the first argument to<br>your program.</p>
<p>You will be provided with the location of the file to serve as the second<br>command-line argument. You must use the fs.createReadStream() method to<br>stream the file contents to the response.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">let http = require(&quot;http&quot;)</div><div class="line">let fs = require(&quot;fs&quot;)</div><div class="line">const file = process.argv[3]</div><div class="line">console.log(file)</div><div class="line">http.createServer((req,res) =&gt; &#123;</div><div class="line">    fs.createReadStream(file).pipe(res)</div><div class="line">&#125;).listen(process.argv[2])</div></pre></td></tr></table></figure></p>
<h3 id="HTTP-UPPERCASERER-Exercise-12-of-13"><a href="#HTTP-UPPERCASERER-Exercise-12-of-13" class="headerlink" title="HTTP UPPERCASERER (Exercise 12 of 13)"></a>HTTP UPPERCASERER (Exercise 12 of 13)</h3><p> Write an HTTP server that receives only POST requests and converts<br> incoming POST body characters to upper-case and returns it to the client.</p>
<p> Your server should listen on the port provided by the first argument to<br> your program.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">let http = require(&quot;http&quot;)</div><div class="line">let map = require(&quot;through2-map&quot;)</div><div class="line"></div><div class="line">http.createServer((req, res) =&gt; &#123;</div><div class="line">    if (req.method == &quot;POST&quot;) &#123;</div><div class="line">        req.pipe(map(chunk =&gt; &#123;</div><div class="line">            return chunk.toString().toUpperCase()</div><div class="line">        &#125;)).pipe(res)</div><div class="line">    &#125;</div><div class="line">&#125;).listen(process.argv[2])</div></pre></td></tr></table></figure></p>
<h3 id="HTTP-JSON-API-SERVER-Exercise-13-of-13"><a href="#HTTP-JSON-API-SERVER-Exercise-13-of-13" class="headerlink" title="HTTP JSON API SERVER (Exercise 13 of 13)"></a>HTTP JSON API SERVER (Exercise 13 of 13)</h3><p> Write an HTTP server that serves JSON data when it receives a GET request<br> to the path ‘/api/parsetime’. Expect the request to contain a query string<br> with a key ‘iso’ and an ISO-format time as the value.</p>
<p> For example:</p>
<p> /api/parsetime?iso=2013-08-10T12:10:15.474Z</p>
<p> The JSON response should contain only ‘hour’, ‘minute’ and ‘second’<br> properties. For example:</p>
<pre><code>{
  &quot;hour&quot;: 14,
  &quot;minute&quot;: 23,
  &quot;second&quot;: 15
}
</code></pre><p> Add second endpoint for the path ‘/api/unixtime’ which accepts the same<br> query string but returns UNIX epoch time in milliseconds (the number of<br> milliseconds since 1 Jan 1970 00:00:00 UTC) under the property ‘unixtime’.<br> For example:</p>
<pre><code>{ &quot;unixtime&quot;: 1376136615474 }
</code></pre><p> Your server should listen on the port provided by the first argument to<br> your program.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">let http = require(&quot;http&quot;)</div><div class="line">let url = require(&quot;url&quot;)</div><div class="line"></div><div class="line">http.createServer((req, res) =&gt; &#123;</div><div class="line">    let urlObj = url.parse(req.url, true)</div><div class="line">    let isoDate = urlObj.query.iso</div><div class="line">    let date = new Date(isoDate)</div><div class="line">    let result</div><div class="line">    if (urlObj.pathname == &quot;/api/parsetime&quot;) &#123;</div><div class="line">        result = res.end(JSON.stringify(&#123;</div><div class="line">            hour: date.getHours(),</div><div class="line">            minute: date.getMinutes(),</div><div class="line">            second: date.getSeconds()</div><div class="line">        &#125;))</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (urlObj.pathname == &quot;/api/unixtime&quot;) &#123;</div><div class="line">        result = res.end(JSON.stringify(&#123;</div><div class="line">            unixtime: date.getTime(),</div><div class="line">        &#125;))</div><div class="line">    &#125;</div><div class="line">    if (result) &#123;</div><div class="line">        res.writeHead(200, &#123;&apos;Content-Type&apos;: &apos;application/json&apos;&#125;)</div><div class="line">        res.end(result)</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        res.writeHead(404)</div><div class="line">        res.end()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;).listen(process.argv[2])</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/14/Cardview源码解析/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="子质">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="子质’s Notes">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="子质’s Notes" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/14/Cardview源码解析/" itemprop="url">
                  CardView源码解析-View阴影
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-14T21:13:09+08:00">
                2017-08-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/08/14/Cardview源码解析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/08/14/Cardview源码解析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/08/14/Cardview源码解析/" class="leancloud_visitors" data-flag-title="CardView源码解析-View阴影">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>CardView 扩展 FrameLayout 类并让您能够显示卡片内的信息，这些信息在整个平台中拥有一致的呈现方式。CardView 小部件可拥有阴影和圆角。</p>
<p>如果要使用阴影创建卡片，请使用 card_view:cardElevation 属性。CardView 在 Android 5.0（API 级别 21）及更高版本中使用真实高度与动态阴影，而在早期的 Android 版本中则返回编程阴影实现</p>
</blockquote>
<p><img src="http://ohe81rx2w.bkt.clouddn.com/1-UFEQBK-ovYrbSkv-F9v5mw.png" alt=""></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">android.support.v7.widget.CardView</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_margin</span>=<span class="string">"16dp"</span>&gt;</div><div class="line">        <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</div><div class="line">            <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line">                <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">                <span class="attr">android:layout_height</span>=<span class="string">"160dp"</span></div><div class="line">                <span class="attr">android:scaleType</span>=<span class="string">"centerCrop"</span></div><div class="line">                <span class="attr">android:src</span>=<span class="string">"@drawable/balon"</span> /&gt;</div><div class="line">            <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">                <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">                <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">                <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></div><div class="line">                <span class="attr">android:padding</span>=<span class="string">"16dp"</span>&gt;</div><div class="line">                <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">                    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">                    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">                    <span class="attr">android:layout_marginBottom</span>=<span class="string">"8dp"</span></div><div class="line">                    <span class="attr">android:text</span>=<span class="string">"@string/card_title"</span></div><div class="line">                    <span class="attr">android:textColor</span>=<span class="string">"#000"</span></div><div class="line">                    <span class="attr">android:textSize</span>=<span class="string">"18sp"</span> /&gt;</div><div class="line">                <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">                    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">                    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">                    <span class="attr">android:text</span>=<span class="string">"@string/card_content"</span></div><div class="line">                    <span class="attr">android:textColor</span>=<span class="string">"#555"</span> /&gt;</div><div class="line">            <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">                <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">                <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span>&gt;</div><div class="line">                <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line">                    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">                    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">                    <span class="attr">android:text</span>=<span class="string">"@string/action_share"</span></div><div class="line">                    <span class="attr">android:theme</span>=<span class="string">"@style/PrimaryFlatButton"</span> /&gt;</div><div class="line">                <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line">                    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">                    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">                    <span class="attr">android:text</span>=<span class="string">"@string/action_explore"</span></div><div class="line">                    <span class="attr">android:theme</span>=<span class="string">"@style/PrimaryFlatButton"</span> /&gt;</div><div class="line">            <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">android.support.v7.widget.CardView</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="CardView的常用属性："><a href="#CardView的常用属性：" class="headerlink" title="CardView的常用属性："></a>CardView的常用属性：</h2><table>
<thead>
<tr>
<th>属性</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>card_view:cardElevation</td>
<td>阴影的大小</td>
</tr>
<tr>
<td>card_view:cardMaxElevation</td>
<td>阴影最大高度</td>
</tr>
<tr>
<td>card_view:cardBackgroundColor</td>
<td>卡片的背景色</td>
</tr>
<tr>
<td>card_view:cardCornerRadius</td>
<td>卡片的圆角大小</td>
</tr>
<tr>
<td>card_view:contentPadding</td>
<td>卡片内容于边距的间隔</td>
</tr>
<tr>
<td>card_view:contentPaddingBottom</td>
<td>卡片内容与底部的边距</td>
</tr>
<tr>
<td>card_view:contentPaddingTop</td>
<td>卡片内容与顶部的边距</td>
</tr>
<tr>
<td>card_view:contentPaddingLeft</td>
<td>卡片内容与左边的边距</td>
</tr>
<tr>
<td>card_view:contentPaddingRight</td>
<td>卡片内容与右边的边距</td>
</tr>
<tr>
<td>card_view:contentPaddingStart</td>
<td>卡片内容于边距的间隔起始</td>
</tr>
<tr>
<td>card_view:contentPaddingEnd</td>
<td>卡片内容于边距的间隔终止</td>
</tr>
<tr>
<td>card_view:cardUseCompatPadding</td>
<td>设置内边距，android5.0(代号：Lollipop，API level 21)及以上的版本和之前的版本仍旧具有一样的计算方式</td>
</tr>
<tr>
<td>card_view:cardPreventConrerOverlap</td>
<td>在android5.0之前的版本中添加内边距，这个属性为了防止内容和边角的重叠</td>
</tr>
</tbody>
</table>
<p>CardView的使用比较简单，网上也有相当多的文章可以参考，本文在此不做过多的阐述。<br>CardView的兼容性考虑，在不同版本的系统上实现有差异，大家在使用时要考虑到这一点，我们先看几个小Demo。</p>
<h3 id="cardPreventConrerOverlap属性："><a href="#cardPreventConrerOverlap属性：" class="headerlink" title="cardPreventConrerOverlap属性："></a>cardPreventConrerOverlap属性：</h3><p>Lollipop以下版本，cardPreventConrerOverlap = false,不设置contentPadding,如图，内容和圆角重叠。</p>
<div align="center"><br><img src="http://ohe81rx2w.bkt.clouddn.com/overlap_false.png" alt=""><br></div>

<p>Lollipop以下版本，cardPreventConrerOverlap = true,不设置contentPadding,如图，添加了额外padding防止内容和圆角为重叠。</p>
<div align="center"><br><img src="http://ohe81rx2w.bkt.clouddn.com/overlap_true_%E7%9C%8B%E5%9B%BE%E7%8E%8B.png" alt=""><br></div>

<p><br></p>
<h3 id="cardUseCompatPadding属性："><a href="#cardUseCompatPadding属性：" class="headerlink" title="cardUseCompatPadding属性："></a>cardUseCompatPadding属性：</h3><p>为了展示出效果，我将elevation设置的比较大，测试设备nexus4 768x1280。<br>下图左侧为Lollipop以下版本，右侧为Lollipop版本，cardUseCompatPadding = false。</p>
<div align="center"><br><img src="http://ohe81rx2w.bkt.clouddn.com/5.0_compat_padding_false.png" alt=""><br></div>

<p><br><br>下图左侧为Lollipop以下版本，右侧为Lollipop版本，cardUseCompatPadding = true。<br><br></p>
<div align="center"><br><img src="http://ohe81rx2w.bkt.clouddn.com/5.0_compat_padding_true.png" alt=""><br></div>

<p>可见，如果想让Lollipop版本及以上的内边距和Lollipop版本以下相同，就需要把该属性设置为true.。</p>
<p>但该属性的影响没你想的那么简单。<br>我们再往布局中添加一个控件，cardUseCompatPadding= false。   </p>
<div align="center"><br><img src="http://ohe81rx2w.bkt.clouddn.com/compat_padding_1.png" alt=""><br></div><br> <br><br>这差距够明显吧！那我们怎样保证各个版本的显示效果相同呢？设置cardUseCompatPadding=true。<br><br><br><br><div align="center"><br><img src="http://ohe81rx2w.bkt.clouddn.com/compat_padding_2.png" alt=""><br></div><br><br><br>这下就ok了，其实导致这种问题出现的根本原因是view的阴影效果在不同版本实现方式存在差异，下文分析源码时会讲到。<br><br>这个问题还有一种解决方式。不设置cardUseCompatPadding属性为true,在Lollipop版本以下对应的dimens.xml中填写cardview的margin = 0dp，在Lollipop版本下（即values-21文件夹）的dimens.xml设置需要的值。<br><br>如果你想给CardView指定明确的宽高呢？<br><br><div align="center"><br><img src="http://ohe81rx2w.bkt.clouddn.com/exct_width_height.png" alt=""><br></div>

<p>什么内容区域大小居然不一样！这种问题要被测试美眉发现岂不是太没面子，怎么解决呢？设置cardUseCompatPadding属性为true。</p>
<div align="center"><br><img src="http://ohe81rx2w.bkt.clouddn.com/exct_width_height_compat_padding_true.png" alt=""><br></div>

<p>同理这这个问题也可以通过不同系统版本dimens.xml来适配。</p>
<h3 id="总结一下"><a href="#总结一下" class="headerlink" title="总结一下"></a>总结一下</h3><ul>
<li><p>CardView通过elevation属性来设置view的阴影，但Lollipop之前的版本是模拟实现，即实现方式不同。</p>
</li>
<li><p>因为裁剪比较耗费性能，所以Lollipop之前的版本不对内部View进行裁剪，通过添加padding的方式避免内部View和圆角重叠。使用setPreventCornerOverlap方法或对应xml card_view:cardPreventConrerOverlap属性可更改这一行为，该属性默认为true。</p>
</li>
<li><p>Lollipop之前的版本，CardView和内容之间添加边距，并在该区域绘制阴影，两边的间距为maxCardElevation + (1 - cos45) <em> cornerRadius，上下的间距为maxCardElevation </em> 1.5 + (1 - cos45) * cornerRadius。</p>
</li>
<li><p>因为padding属性被用来做偏移绘制阴影，所以不能使用CardView的padding属性，如果想设置CardView和其子View之间的边距，可使用setContentPadding(int, int, int, int)方法或对应的xml属性。</p>
</li>
<li><p>如果对CardView设置了明确的尺寸，因为阴影的缘故，其内容区域在Lollipop版本和之前的版本上显示不同，你可以通过不同系统版本使用不同资源值或设置useCompatPadding属性为true的方式来避免此问题。</p>
</li>
<li><p>通过setCardElevation(float)以兼容的方式设置CardView的elevation,CardView会使用Lollipop下或之前版本下的elevation API，进而改变阴影的尺寸。为防止改变阴影尺寸时，view发生移动，阴影大小不会超过MaxCardElevation，如果想在CardView初始化后动态改变阴影大小，应使用setMaxCardElevation(float)方法。</p>
</li>
</ul>
<h2 id="解剖源码。"><a href="#解剖源码。" class="headerlink" title="解剖源码。"></a>解剖源码。</h2><p>结构图如下：</p>
<div align="center"><br><img src="http://ohe81rx2w.bkt.clouddn.com/cardview_uml.png" alt=""><br></div>

<p>CardView内部根据不同版本系统实例化对应的CardViewImpl对象，CardViewImpl对象通过CardViewDelegate对象与CardView交互。</p>
<p>CardView的静态代码块中根据系统版本实例化对应的实现。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> &#123;</div><div class="line">       <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">21</span>) &#123;</div><div class="line">           IMPL = <span class="keyword">new</span> CardViewApi21();</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">17</span>) &#123;</div><div class="line">           IMPL = <span class="keyword">new</span> CardViewJellybeanMr1();</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           IMPL = <span class="keyword">new</span> CardViewGingerbread();</div><div class="line">       &#125;</div><div class="line">       IMPL.initStatic();</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>这里调用了initStatic()，API21中即CardViewApi21类中是空实现，API17中实现如下（CardViewJellybeanMr1）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initStatic</span><span class="params">()</span> </span>&#123;</div><div class="line">        RoundRectDrawableWithShadow.sRoundRectHelper</div><div class="line">                = <span class="keyword">new</span> RoundRectDrawableWithShadow.RoundRectHelper() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawRoundRect</span><span class="params">(Canvas canvas, RectF bounds, <span class="keyword">float</span> cornerRadius,</span></span></div><div class="line">                    Paint paint) &#123;</div><div class="line">                canvas.drawRoundRect(bounds, cornerRadius, cornerRadius, paint);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>API17之前的版本实现如下（CardViewGingerbread）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initStatic</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">//使用7步绘制操作来绘制出圆角矩形，在API17之前的版本此种方式要比canvas.drawRoundRect快,</span></div><div class="line">        <span class="comment">//因为API 11-16使用了alpha蒙版纹理去绘制</span></div><div class="line">        RoundRectDrawableWithShadow.sRoundRectHelper =</div><div class="line">                <span class="keyword">new</span> RoundRectDrawableWithShadow.RoundRectHelper() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawRoundRect</span><span class="params">(Canvas canvas, RectF bounds, <span class="keyword">float</span> cornerRadius,</span></span></div><div class="line">                    Paint paint) &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">float</span> twoRadius = cornerRadius * <span class="number">2</span>;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">float</span> innerWidth = bounds.width() - twoRadius - <span class="number">1</span>;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">float</span> innerHeight = bounds.height() - twoRadius - <span class="number">1</span>;</div><div class="line">                <span class="keyword">if</span> (cornerRadius &gt;= <span class="number">1f</span>) &#123;</div><div class="line">                    <span class="comment">// increment corner radius to account for half pixels.</span></div><div class="line">                    <span class="keyword">float</span> roundedCornerRadius = cornerRadius + .<span class="number">5f</span>;</div><div class="line">                    sCornerRect.set(-roundedCornerRadius, -roundedCornerRadius, roundedCornerRadius,</div><div class="line">                            roundedCornerRadius);</div><div class="line">                    <span class="keyword">int</span> saved = canvas.save();</div><div class="line">                    canvas.translate(bounds.left + roundedCornerRadius,</div><div class="line">                            bounds.top + roundedCornerRadius);</div><div class="line">                    canvas.drawArc(sCornerRect, <span class="number">180</span>, <span class="number">90</span>, <span class="keyword">true</span>, paint);</div><div class="line">                    canvas.translate(innerWidth, <span class="number">0</span>);</div><div class="line">                    canvas.rotate(<span class="number">90</span>);</div><div class="line">                    canvas.drawArc(sCornerRect, <span class="number">180</span>, <span class="number">90</span>, <span class="keyword">true</span>, paint);</div><div class="line">                    canvas.translate(innerHeight, <span class="number">0</span>);</div><div class="line">                    canvas.rotate(<span class="number">90</span>);</div><div class="line">                    canvas.drawArc(sCornerRect, <span class="number">180</span>, <span class="number">90</span>, <span class="keyword">true</span>, paint);</div><div class="line">                    canvas.translate(innerWidth, <span class="number">0</span>);</div><div class="line">                    canvas.rotate(<span class="number">90</span>);</div><div class="line">                    canvas.drawArc(sCornerRect, <span class="number">180</span>, <span class="number">90</span>, <span class="keyword">true</span>, paint);</div><div class="line">                    canvas.restoreToCount(saved);</div><div class="line">                    <span class="comment">//绘制上下两部分</span></div><div class="line">                    canvas.drawRect(bounds.left + roundedCornerRadius - <span class="number">1f</span>, bounds.top,</div><div class="line">                            bounds.right - roundedCornerRadius + <span class="number">1f</span>,</div><div class="line">                            bounds.top + roundedCornerRadius, paint);</div><div class="line"></div><div class="line">                    canvas.drawRect(bounds.left + roundedCornerRadius - <span class="number">1f</span>,</div><div class="line">                            bounds.bottom - roundedCornerRadius,</div><div class="line">                            bounds.right - roundedCornerRadius + <span class="number">1f</span>, bounds.bottom, paint);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// 绘制中间部分</span></div><div class="line">                canvas.drawRect(bounds.left, bounds.top + cornerRadius,</div><div class="line">                        bounds.right, bounds.bottom - cornerRadius , paint);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>API17和之前版本的阴影实现差异主要在这里，因为效率问题，API17之前的版本使用分步绘制测方式绘制圆角矩形。</p>
<p>CardView的构造器中会调用initialize(…),该方法中主要拿到各属性，然后调用具体实现的初始化方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        TypedArray a = context.obtainStyledAttributes(attrs, R.styleable.CardView, defStyleAttr,</div><div class="line">                R.style.CardView);</div><div class="line">        ColorStateList backgroundColor;</div><div class="line">        <span class="keyword">if</span> (a.hasValue(R.styleable.CardView_cardBackgroundColor)) &#123;</div><div class="line">            backgroundColor = a.getColorStateList(R.styleable.CardView_cardBackgroundColor);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// 没有设置背景则从当前主题中提取</span></div><div class="line">            <span class="keyword">final</span> TypedArray aa = getContext().obtainStyledAttributes(COLOR_BACKGROUND_ATTR);</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> themeColorBackground = aa.getColor(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">            aa.recycle();</div><div class="line"></div><div class="line">            <span class="comment">//若主题中的colorBackground是浅色,使用cardview_light_background,否则使用cardview_dark_background</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">float</span>[] hsv = <span class="keyword">new</span> <span class="keyword">float</span>[<span class="number">3</span>];</div><div class="line">            Color.colorToHSV(themeColorBackground, hsv);</div><div class="line">            backgroundColor = ColorStateList.valueOf(hsv[<span class="number">2</span>] &gt; <span class="number">0.5f</span></div><div class="line">                    ? getResources().getColor(R.color.cardview_light_background)</div><div class="line">                    : getResources().getColor(R.color.cardview_dark_background));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">float</span> radius = a.getDimension(R.styleable.CardView_cardCornerRadius, <span class="number">0</span>);</div><div class="line">      	...</div><div class="line">        mUserSetMinHeight = a.getDimensionPixelSize(R.styleable.CardView_android_minHeight, <span class="number">0</span>);</div><div class="line">        a.recycle();</div><div class="line"></div><div class="line">        IMPL.initialize(mCardViewDelegate, context, backgroundColor, radius,</div><div class="line">                elevation, maxElevation);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>接下来我们带着问题来看源码。</p>
<ol>
<li>API19之前版本如何实现阴影？</li>
<li>API19及以上版本如何实现View裁切？</li>
<li>API19及之后版本如何实现阴影？</li>
<li>API19之前版本cardPreventConrerOverlap属性的影响？</li>
<li>API19及以上版本受cardUseCompatPadding属性的影响？</li>
<li>为什么阴影在在x轴方向和y轴方向发生了位移，而不是均匀分布在view四周？</li>
</ol>
<h3 id="问题1：API19之前版本如何实现阴影？"><a href="#问题1：API19之前版本如何实现阴影？" class="headerlink" title="问题1：API19之前版本如何实现阴影？"></a>问题1：API19之前版本如何实现阴影？</h3><p>接下来我们先看API19之前是怎么实现阴影的(CardViewGingerbread类)。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(CardViewDelegate cardView, Context context,</span></span></div><div class="line">           ColorStateList backgroundColor, <span class="keyword">float</span> radius, <span class="keyword">float</span> elevation, <span class="keyword">float</span> maxElevation) &#123;</div><div class="line">       RoundRectDrawableWithShadow background = createBackground(context, backgroundColor, radius,</div><div class="line">               elevation, maxElevation);</div><div class="line">       background.setAddPaddingForCorners(cardView.getPreventCornerOverlap());</div><div class="line">       cardView.setCardBackground(background);</div><div class="line">       updatePadding(cardView);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>看来它的阴影是由RoundRectDrawableWithShadow类来实现的。<br>我们来看看来它的阴影是由RoundRectDrawableWithShadow类来实现的onDraw,第一次调用要走buildComponents方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mDirty) &#123;</div><div class="line">            buildComponents(getBounds());</div><div class="line">            mDirty = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        canvas.translate(<span class="number">0</span>, mRawShadowSize / <span class="number">2</span>);</div><div class="line">        drawShadow(canvas);</div><div class="line">        canvas.translate(<span class="number">0</span>, -mRawShadowSize / <span class="number">2</span>);</div><div class="line">        sRoundRectHelper.drawRoundRect(canvas, mCardBounds, mCornerRadius, mPaint);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>buildComponents方法中，mRawMaxShadowSize其实就是maxElevation，此处确定了cardview的边界，上下左右都进行了偏移，空出来的区域是为了绘制阴影。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildComponents</span><span class="params">(Rect bounds)</span> </span>&#123;</div><div class="line">      <span class="comment">// Card is offset SHADOW_MULTIPLIER * maxShadowSize to account for the shadow shift.</span></div><div class="line">      <span class="comment">// We could have different top-bottom offsets to avoid extra gap above but in that case</span></div><div class="line">      <span class="comment">// center aligning Views inside the CardView would be problematic.</span></div><div class="line">      <span class="keyword">final</span> <span class="keyword">float</span> verticalOffset = mRawMaxShadowSize * SHADOW_MULTIPLIER;</div><div class="line">      mCardBounds.set(bounds.left + mRawMaxShadowSize, bounds.top+verticalOffset,</div><div class="line">              bounds.right - mRawMaxShadowSize, bounds.bottom - verticalOffset);</div><div class="line"></div><div class="line">      buildShadowCorners();</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>buildShadowCorners方法中初始化了绘制边阴影和角阴影的path。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildShadowCorners</span><span class="params">()</span> </span>&#123;</div><div class="line">        RectF innerBounds = <span class="keyword">new</span> RectF(-mCornerRadius, -mCornerRadius, mCornerRadius, mCornerRadius);</div><div class="line">        RectF outerBounds = <span class="keyword">new</span> RectF(innerBounds);</div><div class="line">        outerBounds.inset(-mShadowSize, -mShadowSize);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mCornerShadowPath == <span class="keyword">null</span>) &#123;</div><div class="line">            mCornerShadowPath = <span class="keyword">new</span> Path();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mCornerShadowPath.reset();</div><div class="line">        &#125;</div><div class="line">        mCornerShadowPath.setFillType(Path.FillType.EVEN_ODD);</div><div class="line">        mCornerShadowPath.moveTo(-mCornerRadius, <span class="number">0</span>);</div><div class="line">        mCornerShadowPath.rLineTo(-mShadowSize, <span class="number">0</span>);</div><div class="line">        <span class="comment">// outer arc</span></div><div class="line">        mCornerShadowPath.arcTo(outerBounds, <span class="number">180f</span>, <span class="number">90f</span>, <span class="keyword">false</span>);</div><div class="line">        <span class="comment">// inner arc</span></div><div class="line">        mCornerShadowPath.arcTo(innerBounds, <span class="number">270f</span>, -<span class="number">90f</span>, <span class="keyword">false</span>);</div><div class="line">        mCornerShadowPath.close();</div><div class="line">        <span class="keyword">float</span> startRatio = mCornerRadius / (mCornerRadius + mShadowSize);</div><div class="line">        mCornerShadowPaint.setShader(<span class="keyword">new</span> RadialGradient(<span class="number">0</span>, <span class="number">0</span>, mCornerRadius + mShadowSize,</div><div class="line">                <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;mShadowStartColor, mShadowStartColor, mShadowEndColor&#125;,</div><div class="line">                <span class="keyword">new</span> <span class="keyword">float</span>[]&#123;<span class="number">0f</span>, startRatio, <span class="number">1f</span>&#125;</div><div class="line">                , Shader.TileMode.CLAMP));</div><div class="line"></div><div class="line">        <span class="comment">// we offset the content shadowSize/2 pixels up to make it more realistic.</span></div><div class="line">        <span class="comment">// this is why edge shadow shader has some extra space</span></div><div class="line">        <span class="comment">// When drawing bottom edge shadow, we use that extra space.</span></div><div class="line">        mEdgeShadowPaint.setShader(<span class="keyword">new</span> LinearGradient(<span class="number">0</span>, -mCornerRadius + mShadowSize, <span class="number">0</span>,</div><div class="line">                -mCornerRadius - mShadowSize,</div><div class="line">                <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;mShadowStartColor, mShadowStartColor, mShadowEndColor&#125;,</div><div class="line">                <span class="keyword">new</span> <span class="keyword">float</span>[]&#123;<span class="number">0f</span>, .<span class="number">5f</span>, <span class="number">1f</span>&#125;, Shader.TileMode.CLAMP));</div><div class="line">        mEdgeShadowPaint.setAntiAlias(<span class="keyword">false</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>接下来看drawShadow方法，这里基本的canvas操作。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawShadow</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">float</span> edgeShadowTop = -mCornerRadius - mShadowSize;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">float</span> inset = mCornerRadius + mInsetShadow + mRawShadowSize / <span class="number">2</span>;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> drawHorizontalEdges = mCardBounds.width() - <span class="number">2</span> * inset &gt; <span class="number">0</span>;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> drawVerticalEdges = mCardBounds.height() - <span class="number">2</span> * inset &gt; <span class="number">0</span>;</div><div class="line">        <span class="comment">// LT</span></div><div class="line">        <span class="keyword">int</span> saved = canvas.save();</div><div class="line">        canvas.translate(mCardBounds.left + inset, mCardBounds.top + inset);</div><div class="line">        canvas.drawPath(mCornerShadowPath, mCornerShadowPaint);</div><div class="line">        <span class="keyword">if</span> (drawHorizontalEdges) &#123;</div><div class="line">            canvas.drawRect(<span class="number">0</span>, edgeShadowTop,</div><div class="line">                    mCardBounds.width() - <span class="number">2</span> * inset, -mCornerRadius,</div><div class="line">                    mEdgeShadowPaint);</div><div class="line">        &#125;</div><div class="line">        canvas.restoreToCount(saved);</div><div class="line">        <span class="comment">// RB</span></div><div class="line">        saved = canvas.save();</div><div class="line">        canvas.translate(mCardBounds.right - inset, mCardBounds.bottom - inset);</div><div class="line">        canvas.rotate(<span class="number">180f</span>);</div><div class="line">        canvas.drawPath(mCornerShadowPath, mCornerShadowPaint);</div><div class="line">        <span class="keyword">if</span> (drawHorizontalEdges) &#123;</div><div class="line">            canvas.drawRect(<span class="number">0</span>, edgeShadowTop,</div><div class="line">                    mCardBounds.width() - <span class="number">2</span> * inset, -mCornerRadius + mShadowSize,</div><div class="line">                    mEdgeShadowPaint);</div><div class="line">        &#125;</div><div class="line">        canvas.restoreToCount(saved);</div><div class="line">        <span class="comment">// LB</span></div><div class="line">        saved = canvas.save();</div><div class="line">        canvas.translate(mCardBounds.left + inset, mCardBounds.bottom - inset);</div><div class="line">        canvas.rotate(<span class="number">270f</span>);</div><div class="line">        canvas.drawPath(mCornerShadowPath, mCornerShadowPaint);</div><div class="line">        <span class="keyword">if</span> (drawVerticalEdges) &#123;</div><div class="line">            canvas.drawRect(<span class="number">0</span>, edgeShadowTop,</div><div class="line">                    mCardBounds.height() - <span class="number">2</span> * inset, -mCornerRadius, mEdgeShadowPaint);</div><div class="line">        &#125;</div><div class="line">        canvas.restoreToCount(saved);</div><div class="line">        <span class="comment">// RT</span></div><div class="line">        saved = canvas.save();</div><div class="line">        canvas.translate(mCardBounds.right - inset, mCardBounds.top + inset);</div><div class="line">        canvas.rotate(<span class="number">90f</span>);</div><div class="line">        canvas.drawPath(mCornerShadowPath, mCornerShadowPaint);</div><div class="line">        <span class="keyword">if</span> (drawVerticalEdges) &#123;</div><div class="line">            canvas.drawRect(<span class="number">0</span>, edgeShadowTop,</div><div class="line">                    mCardBounds.height() - <span class="number">2</span> * inset, -mCornerRadius, mEdgeShadowPaint);</div><div class="line">        &#125;</div><div class="line">        canvas.restoreToCount(saved);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>可见API19之前阴影的实现是由canvas+path+RadialGradient绘制角阴影,canvas+path+LinearGradient绘制边阴影。</p>
<h3 id="问题2：API19及以上版本如何实现View裁切？"><a href="#问题2：API19及以上版本如何实现View裁切？" class="headerlink" title="问题2：API19及以上版本如何实现View裁切？"></a>问题2：API19及以上版本如何实现View裁切？</h3><p>进入CardViewApi21类，<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(CardViewDelegate cardView, Context context,</span></span></div><div class="line">                           ColorStateList backgroundColor, <span class="keyword">float</span> radius, <span class="keyword">float</span> elevation, <span class="keyword">float</span> maxElevation) &#123;</div><div class="line">        <span class="keyword">final</span> RoundRectDrawable background = <span class="keyword">new</span> RoundRectDrawable(backgroundColor, radius);</div><div class="line">        cardView.setCardBackground(background);</div><div class="line"></div><div class="line">        View view = cardView.getCardView();</div><div class="line">        view.setClipToOutline(<span class="keyword">true</span>);</div><div class="line">        view.setElevation(elevation);</div><div class="line">        setMaxElevation(cardView, maxElevation);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>这里实例化了RoundRectDrawable作为cardview的背景。RoundRectDrawable是用来绘制背景圆角矩形，<br> cardView.getCardView()拿到了CardView对象，前面我们说了CardView是继承自FrameLayout的，所以CardView即是ViewGroup也是View,view.setClipToOutline(true)是什么意思呢？</p>
<p><strong>android5.0之后允许自定义视图阴影与轮廓</strong><br>视图的背景可绘制对象的边界将决定其阴影的默认形状。轮廓代表图形对象的外形并定义触摸反馈的波纹区域。</p>
<p>下面举一个以背景可绘制对象定义的视图示例：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/myview"</span></div><div class="line">    <span class="attr">...</span></div><div class="line">    <span class="attr">android:elevation</span>=<span class="string">"2dp"</span></div><div class="line">    <span class="attr">android:background</span>=<span class="string">"@drawable/myrect"</span> /&gt;</div></pre></td></tr></table></figure></p>
<p>背景可绘制对象被定义为一个拥有圆角的矩形：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- res/drawable/myrect.xml --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">shape</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">       <span class="attr">android:shape</span>=<span class="string">"rectangle"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">solid</span> <span class="attr">android:color</span>=<span class="string">"#42000000"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">corners</span> <span class="attr">android:radius</span>=<span class="string">"5dp"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">shape</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>视图将投射一个带有圆角的阴影，因为背景可绘制对象将定义视图的轮廓。 如果提供一个自定义轮廓，则此轮廓将替换视图阴影的默认形状。</p>
<p>如果要为代码中的视图定义自定义轮廓：<br>扩展 ViewOutlineProvider 类别。<br>替代 getOutline() 方法。<br>利用 View.setOutlineProvider() 方法向您的视图指定新的轮廓提供程序。<br>您可使用 Outline 类别中的方法创建带有圆角的椭圆形和矩形轮廓。视图的默认轮廓提供程序将从视图背景取得轮廓。 如果要防止视图投射阴影，请将其轮廓提供程序设置为 null。</p>
<p><strong>裁剪视图</strong><br>裁剪视图让您能够轻松改变视图形状。您可以裁剪视图，以便与其他设计元素保持一致，也可以根据用户输入改变视图形状。您可使用 View.setClipToOutline() 方法或 android:clipToOutline 属性将视图裁剪至其轮廓区域。 由 Outline.canClip() 方法所决定，仅有矩形、圆形和圆角矩形轮廓支持裁剪。</p>
<p>如果要将视图裁剪至可绘制对象的形状，请将可绘制对象设置为视图背景（如上所示）并调用 View.setClipToOutline() 方法。</p>
<h3 id="问题3：-API19及之后版本如何实现阴影？"><a href="#问题3：-API19及之后版本如何实现阴影？" class="headerlink" title="问题3： API19及之后版本如何实现阴影？"></a>问题3： API19及之后版本如何实现阴影？</h3><p>CardViewApi21的initialize方法中调用了view.setElevation(elevation),<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setElevation</span><span class="params">(<span class="keyword">float</span> elevation)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (elevation != getElevation()) &#123;</div><div class="line">            invalidateViewProperty(<span class="keyword">true</span>, <span class="keyword">false</span>);</div><div class="line">            mRenderNode.setElevation(elevation);</div><div class="line">            invalidateViewProperty(<span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">            invalidateParentIfNeededAndWasQuickRejected();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>再看mRenderNode.setElevation(elevation);<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">	 public boolean setElevation(float lift) &#123;</div><div class="line">        return nSetElevation(mNativeRenderNode, lift);</div><div class="line">    &#125;</div><div class="line">```	</div><div class="line">nSetElevation(mNativeRenderNode, lift)是个native方法，由此可见android5.0开始所有的view都可以显示阴影，而且是根据elevation属性直接有native方法来实现。</div><div class="line"></div><div class="line">android5.0开始因为加入了Material Design,Material Design 为 UI 元素引入高度，为View加上了Z属性。</div><div class="line"></div><div class="line">由 Z 属性所表示的视图高度将决定其阴影的视觉外观：拥有较高 Z 值的视图将投射更大且更柔和的阴影。 拥有较高 Z 值的视图将挡住拥有较低 Z 值的视图；不过视图的 Z 值并不影响视图的大小。</div><div class="line"></div><div class="line">视图的 Z 值包含两个组件：</div><div class="line"></div><div class="line">高度：静态组件。</div><div class="line">转换：用于动画的动态组件。</div><div class="line">Z = elevation + translationZ</div><div class="line"></div><div class="line">所以影响View阴影的因素有两个elevation和translationZ.</div><div class="line">在 Material Design Guidelines 中有建议卡片、按钮这类元素触摸时应当有一个浮起的效果，也就是增大 Z 轴位移,我们怎么实现这个效果呢？</div><div class="line">&lt;div align=center&gt;</div><div class="line">&lt;img src="http://ohe81rx2w.bkt.clouddn.com/1445743952107919.gif"  alt=""/&gt;</div><div class="line">&lt;/div&gt;</div><div class="line"></div><div class="line">只需要借助 Lollipop 的一个新属性 android:stateListAnimator，创建一个 TranslationZ 的变换动画放在 /res/anim,自己取一个名（如 touch_raise.xml），加入以下内容：</div><div class="line">```xml</div><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line">&lt;selector xmlns:android="http://schemas.android.com/apk/res/android"&gt;</div><div class="line">	&lt;item android:state_enabled="true" android:state_pressed="true"&gt;</div><div class="line">		&lt;objectAnimator</div><div class="line">		android:duration="@android:integer/config_shortAnimTime"</div><div class="line">		android:propertyName="translationZ"</div><div class="line">		android:valueTo="@dimen/touch_raise"</div><div class="line">		android:valueType="floatType" /&gt;</div><div class="line">	&lt;/item&gt;</div><div class="line">	&lt;item&gt;</div><div class="line">		&lt;objectAnimator</div><div class="line">		android:duration="@android:integer/config_shortAnimTime"</div><div class="line">		android:propertyName="translationZ"</div><div class="line">		android:valueTo="0dp"</div><div class="line">		android:valueType="floatType" /&gt;</div><div class="line">	&lt;/item&gt;</div><div class="line">&lt;/selector&gt;</div></pre></td></tr></table></figure></p>
<p>然后为你需要添加效果的 CardView（其他 View 同理）所在的 Layout XML 复制多一份到 /res/layout-v21，然后在新的那份 XML 的 CardView 中加入属性 android:stateListAnimator=”@anim/touch_raise”。这样，你的卡片按住时就会有浮起（阴影加深）的效果了。<br>至于波纹效果只需要给CardView加上android:foreground=”?attr/selectableItemBackground” 属性即可。</p>
<h3 id="问题4：API19之前版本cardPreventConrerOverlap属性的影响？"><a href="#问题4：API19之前版本cardPreventConrerOverlap属性的影响？" class="headerlink" title="问题4：API19之前版本cardPreventConrerOverlap属性的影响？"></a>问题4：API19之前版本cardPreventConrerOverlap属性的影响？</h3><p>CardView的setPreventCornerOverlap方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPreventCornerOverlap</span><span class="params">(<span class="keyword">boolean</span> preventCornerOverlap)</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (preventCornerOverlap != mPreventCornerOverlap) &#123;</div><div class="line">          mPreventCornerOverlap = preventCornerOverlap;</div><div class="line">          IMPL.onPreventCornerOverlapChanged(mCardViewDelegate);</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>然后看CardViewGingerbread的onPreventCornerOverlapChanged方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPreventCornerOverlapChanged</span><span class="params">(CardViewDelegate cardView)</span> </span>&#123;</div><div class="line">       getShadowBackground(cardView).setAddPaddingForCorners(cardView.getPreventCornerOverlap());</div><div class="line">       updatePadding(cardView);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>一路跟踪下来，发现关键点在RoundRectDrawableWithShadow中，addPaddingForCorners即为传过来的preventCornerOverlap，当preventCornerOverlap为true时，内边距增加了(1 - COS_45) * cornerRadius)，这样CardView的子View就不会和圆角重叠了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">float</span> <span class="title">calculateVerticalPadding</span><span class="params">(<span class="keyword">float</span> maxShadowSize, <span class="keyword">float</span> cornerRadius,</span></span></div><div class="line">                                          <span class="keyword">boolean</span> addPaddingForCorners) &#123;</div><div class="line">        <span class="keyword">if</span> (addPaddingForCorners) &#123;</div><div class="line">            <span class="keyword">return</span> (<span class="keyword">float</span>) (maxShadowSize * SHADOW_MULTIPLIER + (<span class="number">1</span> - COS_45) * cornerRadius);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> maxShadowSize * SHADOW_MULTIPLIER;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h3 id="问题5-API19及以上版本受cardUseCompatPadding属性的影响？"><a href="#问题5-API19及以上版本受cardUseCompatPadding属性的影响？" class="headerlink" title="问题5  API19及以上版本受cardUseCompatPadding属性的影响？"></a>问题5  API19及以上版本受cardUseCompatPadding属性的影响？</h3><p>CardView的setUseCompatPadding方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUseCompatPadding</span><span class="params">(<span class="keyword">boolean</span> useCompatPadding)</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (mCompatPadding != useCompatPadding) &#123;</div><div class="line">          mCompatPadding = useCompatPadding;</div><div class="line">          IMPL.onCompatPaddingChanged(mCardViewDelegate);</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>进入CardViewApi21。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompatPaddingChanged</span><span class="params">(CardViewDelegate cardView)</span> </span>&#123;</div><div class="line">       setMaxElevation(cardView, getMaxElevation(cardView));</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>最后跟踪到RoundRectDrawable,这里的mInsetForPadding就是cardUseCompatPadding属性的值，当cardUseCompatPadding属性为true时，会设置内边距，calculateVerticalPadding和calculateHorizontalPadding方法是RoundRectDrawableWithShadow的静态方法，如此5.0和之前版本就具有相同的内边距计算方式了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateBounds</span><span class="params">(Rect bounds)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (bounds == <span class="keyword">null</span>) &#123;</div><div class="line">            bounds = getBounds();</div><div class="line">        &#125;</div><div class="line">        mBoundsF.set(bounds.left, bounds.top, bounds.right, bounds.bottom);</div><div class="line">        mBoundsI.set(bounds);</div><div class="line">        <span class="keyword">if</span> (mInsetForPadding) &#123;</div><div class="line">            <span class="keyword">float</span> vInset = calculateVerticalPadding(mPadding, mRadius, mInsetForRadius);</div><div class="line">            <span class="keyword">float</span> hInset = calculateHorizontalPadding(mPadding, mRadius, mInsetForRadius);</div><div class="line">            mBoundsI.inset((<span class="keyword">int</span>) Math.ceil(hInset), (<span class="keyword">int</span>) Math.ceil(vInset));</div><div class="line">            <span class="comment">// to make sure they have same bounds.</span></div><div class="line">            mBoundsF.set(mBoundsI);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>在CardViewApi21的updatePadding方法也可以看到，如果不设置cardUseCompatPadding,其阴影内边距为0，这也就解释了前文中的现象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updatePadding</span><span class="params">(CardViewDelegate cardView)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!cardView.getUseCompatPadding()) &#123;</div><div class="line">            cardView.setShadowPadding(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">float</span> elevation = getMaxElevation(cardView);</div><div class="line">        <span class="keyword">final</span> <span class="keyword">float</span> radius = getRadius(cardView);</div><div class="line">        <span class="keyword">int</span> hPadding = (<span class="keyword">int</span>) Math.ceil(RoundRectDrawableWithShadow</div><div class="line">                .calculateHorizontalPadding(elevation, radius, cardView.getPreventCornerOverlap()));</div><div class="line">        <span class="keyword">int</span> vPadding = (<span class="keyword">int</span>) Math.ceil(RoundRectDrawableWithShadow</div><div class="line">                .calculateVerticalPadding(elevation, radius, cardView.getPreventCornerOverlap()));</div><div class="line">        cardView.setShadowPadding(hPadding, vPadding, hPadding, vPadding);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h3 id="问题6-为什么阴影在在x轴方向和y轴方向发生了位移，而不是均匀分布在view四周？"><a href="#问题6-为什么阴影在在x轴方向和y轴方向发生了位移，而不是均匀分布在view四周？" class="headerlink" title="问题6  为什么阴影在在x轴方向和y轴方向发生了位移，而不是均匀分布在view四周？"></a>问题6  为什么阴影在在x轴方向和y轴方向发生了位移，而不是均匀分布在view四周？</h3><p>在RoundRectDrawableWithShadow的draw方法中，我们看到，在绘制阴影前，画布向y轴正方向进行了位移，这就使得阴影的方向发生了变化。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (mDirty) &#123;</div><div class="line">           buildComponents(getBounds());</div><div class="line">           mDirty = <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line">       canvas.translate(<span class="number">0</span>, mRawShadowSize / <span class="number">2</span>);</div><div class="line">       drawShadow(canvas);</div><div class="line">       canvas.translate(<span class="number">0</span>, -mRawShadowSize / <span class="number">2</span>);</div><div class="line">       sRoundRectHelper.drawRoundRect(canvas, mCardBounds, mCornerRadius, mPaint);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>如果项目的设计符合Material Design，那最好，如果设计有一天让你实现四周带相同尺寸阴影的效果呢？我们也知道怎么做了吧！<br>这里我把实现方式放到<a href="https://github.com/Proton626/FakeCardView" target="_blank" rel="external">Github</a>上了，有需要欢迎关注。</p>
<p> 参考资料：<br><a href="https://developer.android.com/training/material/lists-cards.html#Dependencies" target="_blank" rel="external">https://developer.android.com/training/material/lists-cards.html#Dependencies</a><br><a href="http://www.jianshu.com/p/33b1d21d6ba6" target="_blank" rel="external">http://www.jianshu.com/p/33b1d21d6ba6</a><br><a href="https://developer.android.com/training/material/shadows-clipping.html#Shadows" target="_blank" rel="external">https://developer.android.com/training/material/shadows-clipping.html#Shadows</a><br><a href="https://android.jlelse.eu/android-card-view-edb905e67cd6" target="_blank" rel="external">https://android.jlelse.eu/android-card-view-edb905e67cd6</a><br><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/1025/3621.html" target="_blank" rel="external">http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/1025/3621.html</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/17/aboutme/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="子质">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="子质’s Notes">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="子质’s Notes" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/17/aboutme/" itemprop="url">
                  人生就像一盒巧克力：About me.
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-17T09:49:28+08:00">
                2017-07-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/随心记/" itemprop="url" rel="index">
                    <span itemprop="name">随心记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/07/17/aboutme/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/17/aboutme/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/07/17/aboutme/" class="leancloud_visitors" data-flag-title="人生就像一盒巧克力：About me.">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://image.135editor.com/files/users/253/2537090/201707/XnwZsGz5_Sx2p.jpg" alt=""></p>
<p>90后程序猿，感觉这个搭配有点绝情，为什么这么说呢？有人说90后垮掉的一代，有人说程序猿是吃青春饭，是不是有点同情我，但我要说这个世界最不缺就是偏见，时间会证明一切。</p>
<p>在大厂当过螺丝钉，也在小创挑过大梁，俗话说干一行爱一行，但我觉得我是爱一行干一行，沉迷代码无药可救，如果可怜我，介绍个对象也是可以的，嘿嘿。</p>
<p>吊车尾211本科一枚，非科班出身，当然我也是有外企工作经历的，在世界500强干过，肯德基后厨做汉堡，难忘的经历，发过传单干过销售，做过遥感数据处理，现在专心写代码，具体点就是Android程序猿，但我向来认为软件工程师就不能定义的那么狭隘，如果老板今天让我去后台写Python，我敢说不吗？当然上啊！</p>
<p>有幸共事过的人有斯坦福大牛、名校硕博，当然还有法语专业转来搬砖的，接触的人越多越觉得自己渺小，越能客观的与人相处，感觉人也是符合冰山理论的，仅靠水面上的一角来下定论是有偏颇的。发现大家经常喜欢下意识地拿薪水来界定程序猿地技术水平，薪资一定程度会显示技术但并不是绝对的，行内人都懂的，展开来讲就啰嗦了。</p>
<p><img src="http://image.135editor.com/files/users/253/2537090/201707/q9WpmjCC_Wj84.jpg" alt=""></p>
<p>程序猿不等于屌丝，当然前提是资产不是界定屌丝的标准。</p>
<p>除了代码我还喜欢健身，目前身上的腱子肉也是很可观的，有机会爆照，哈哈，欢迎交流。</p>
<p>猫瘾晚期，一天不撸猫就喘不过气睡不着觉，目前家中供养着一只英短蓝猫，偶尔指点我写代码，这些代码若被老板看见，估计我得被叫去问话了:公司雇你来是写bug的吗？</p>
<p>“财迷”一个，此处指的理财，人的收入是分为两部分的，主动收入和被动收入，要想实现财务自由不理财怎么能行，互金、基金、股票等，欢迎交流经验，就像老罗说的，知识要做爱才能产生新的灵感。</p>
<p>个人公众号上可能会发技术分享、职场感悟、理财相关等等，欢迎关注我，也欢迎和我互动，如果觉得我是贱人就是矫情，随时取关也是可以的，如果不嫌麻烦给我发个消息埋汰一两句，也是OK的。<br><br></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/14/APP复杂列表数据解析的一个小技巧/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="子质">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="子质’s Notes">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="子质’s Notes" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/14/APP复杂列表数据解析的一个小技巧/" itemprop="url">
                  APP复杂列表数据解析的一个小技巧
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-14T17:27:29+08:00">
                2017-07-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/07/14/APP复杂列表数据解析的一个小技巧/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/14/APP复杂列表数据解析的一个小技巧/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/07/14/APP复杂列表数据解析的一个小技巧/" class="leancloud_visitors" data-flag-title="APP复杂列表数据解析的一个小技巧">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://image.135editor.com/files/users/253/2537090/201707/vrhE2OwH_G6Gx.jpg" alt=""></p>
<blockquote>
<p>最近遇到个小问题，不是什么技术难点，但也是种思路嘛！分享出来给大家看看。</p>
</blockquote>
<p>相信大家都做过复杂类型的列表页，一般APP的首页都是这样的。</p>
<p>服务器返回的是json数据，我们可以通过Fastjson或Gson直接将json字符串转换为对应的java bean即可，java由于是强类型的，所以必须实现定义好类型，我们来看个例子：<br>假如服务器返回的数据是这样的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">	&#123;</div><div class="line">		“type&quot; = 1</div><div class="line">		&quot;a&quot;     =&#123;...&#125;</div><div class="line">		&quot;b&quot;     =null</div><div class="line">		&quot;c&quot;     =null</div><div class="line">	&#125;</div><div class="line">	&#123;</div><div class="line">		“type&quot; = 2</div><div class="line">		&quot;b&quot;     =&#123;...&#125;</div><div class="line">		&quot;a&quot;     =null</div><div class="line">		&quot;c&quot;     =null</div><div class="line">	&#125;</div><div class="line">	&#123;</div><div class="line">		“type&quot; = 3</div><div class="line">		&quot;c&quot;     =&#123;...&#125;</div><div class="line">		&quot;a&quot;     =null</div><div class="line">		&quot;b&quot;     =null</div><div class="line">	&#125;</div><div class="line">	...</div><div class="line">]</div></pre></td></tr></table></figure></p>
<p>当然实际开发时数据要复杂得多。我们对应的首页的bean可以定义三个字段type、a、b，json数据转换为对象时，类型相对的字段就会被赋上值，列表时也可以根据类型来填充。</p>
<p>如果服务器返回的数据是这样呢？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">	&#123;</div><div class="line">		&quot;type&quot; = 1</div><div class="line">		&quot;data&quot; =&#123;...&#125;</div><div class="line">	&#125;</div><div class="line">	&#123;</div><div class="line">		&quot;type&quot; = 3</div><div class="line">		&quot;data&quot; =&#123;...&#125;</div><div class="line">	&#125;</div><div class="line">	&#123;</div><div class="line">		&quot;type&quot; = 2</div><div class="line">		&quot;data&quot; =&#123;...&#125;</div><div class="line">	&#125;</div><div class="line">	...</div><div class="line">]</div></pre></td></tr></table></figure></p>
<p>这种情况就尴尬了，不同类型对应不同的bean，java的列表是只允许存放相同类型数据的，既然我们无法在json转换为对象时确定data的具体类型，那么可以这样定义bean:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">class Test&#123;</div><div class="line">	var type:Int = 0</div><div class="line">	var data:JsonObject? = null</div><div class="line">	</div><div class="line">	//再定义实际类型的字段</div><div class="line">	var a:A?=null</div><div class="line">		get()&#123;</div><div class="line">			val gson = Gson()</div><div class="line">            val jsonElement = jo!!.get(&quot;data&quot;).asJsonArray</div><div class="line">            return gson.fromJson(gson.toJson(jsonElement), object : TypeToken&lt;A&gt;&gt;() &#123;&#125;.type)</div><div class="line">		&#125;</div><div class="line">		var b:B?=null</div><div class="line">		get()&#123;</div><div class="line">			val gson = Gson()</div><div class="line">            val jsonElement = jo!!.get(&quot;data&quot;).asJsonArray</div><div class="line">            return gson.fromJson(gson.toJson(jsonElement), object : TypeToken&lt;B&gt;&gt;() &#123;&#125;.type)</div><div class="line">		&#125;</div><div class="line">		...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后你就可以拿着list:List\<test>愉快的填充列表了，只要你在渲染type=1时乖乖去拿对应的a字段就ok了，其他类似，当然如果有列表的也是同理。</test></p>
<p>retrofit添加Gson转换器直接将json转换为对象了，所以会有这种问题，当然你也可以直接根据key来操作返回的json串，方法有很多，你可以选择你喜欢的方式。</p>
<p>当然如果你可以让服务器哥们修改返回的数据结构也是可以的，前提是你要和IOS组的哥们串通好，不然容易被怼。如果你要更好的方式也欢迎和我交流。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/14/回顾过去，展望未来/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="子质">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="子质’s Notes">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="子质’s Notes" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/14/回顾过去，展望未来/" itemprop="url">
                  回顾过去展望未来
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-14T10:55:42+08:00">
                2017-07-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/随心记/" itemprop="url" rel="index">
                    <span itemprop="name">随心记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/07/14/回顾过去，展望未来/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/14/回顾过去，展望未来/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/07/14/回顾过去，展望未来/" class="leancloud_visitors" data-flag-title="回顾过去展望未来">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://image.135editor.com/files/users/253/2537090/201707/TntLRZLb_DkI2.jpg" alt=""></p>
<p>时间犹如白驹过隙，17年半年都过去了，还记得年初定的计划吗？现在的进展如何？当初信誓旦旦立下的承诺，如今是否还在坚持着。 所以我想写点文字，总结逝去的上半年，展望眼下的下半年。 这个公众号我开通也有段时间了，但直到最近才下定决心把它做下去，我想用它记录我的成长，同时做一些技术分享，虽然目前也没什么读者，但我相信我会慢慢结交到更多朋友的。 虽然现在做技术研发工作，具体点就是Android程序猿啦，但大学学的是地理专业，虽然是个211，但也就那样，感觉国内的大学除了985，其他学校都差不多吧！大学只不过是换个地方打游戏而已，还好我稍微有一点危机感，除了打游戏也规划了一下自己的职业方向。</p>
<p><img src="http://image.135editor.com/files/users/253/2537090/201707/q8DHTXHd_aA2M.jpg" alt=""></p>
<p>记得在校的时候，学校有游泳馆，但那时候去游泳馆完全是去洗澡的，游泳馆拿学生证收费比洗浴中心便宜，北方洗澡都是去公共澡堂的，但那时候想着反正都来了。为啥不学学游泳呢？于是和几个小伙伴一起约定学游泳，结果不到一个月就没剩几个人了，我还坚持着，那时候也没人教，就自己看视频琢磨，扑腾了两个月终于学会蛙泳了，那种成就感就像你的程序一次跑通了似的，非常棒，然后之后我就可以去深水区畅游了，再也不用在浅水区和小朋友大叔大妈们下饺子了，不过第一次下深水区还是挺紧张的，万事开头难，一旦你成功了一次，下次就很简单了。</p>
<p>还有两件事也在大学里坚持了两年，一是练跆拳道，而是学韩语。练过跆拳道的人都知道，跆拳道主要是腿功，需要高踢腿，所以每次必做的练习就是压腿，把腿筋膜拉开，要练成一字马那样，每次上完课基本都走不了路了，开始的那段时间，每次上厕所都费劲，酸爽的很。</p>
<p>大学空闲时间挺多的，平时我会打些工，大学生做兼职，无非就是做做家教，端端盘子，不过那时候我还在快餐店后厨做汉堡炸鸡，这个经历对我影响也蛮大的，那个快餐店在飞机场了，又一次飞机延误，有个团体来订餐，一次性点了200个汉堡，整个后厨忙的手忙脚乱的，我现在还印象深刻，那趟延误的飞机是飞往天津的。刚开始学做汉堡的时候，一站就是一天，也不敢坐着，背各种菜单，每种汉堡放什么酱，放菜的顺序等等，炸鸡的时间，乐薯鸡的做法等等，虽然都是流程化的东西，但东西很多也很杂，因为夜班基本后厨就一人，所以要求所有东西都会做，那时候店长怕冷，我值班的时候还得帮他去冷库清点货物，大冬天的进冷库，那感觉现在想想都想打冷颤，每天清洁后厨，换油神马的，总之就是累，但工资却很少，那时候我就下定决心一定要做一份自己喜欢的有利于个人成长的工作。</p>
<p>想想也挺佩服自己的，那时候打工挺忙的，好不容易挣点钱，除了给自己换新手机，剩下的就拿来交学费了，前文我也提到，还有一件坚持下来的事就是学韩语，有课的时候去上课，没课的时候就自己在看书做笔记，慢慢也学到中级了，最后和韩语老师一块儿吃饭的时候，都说能坚持下来也挺不容易的，因为他带过好多学生都没能坚持下来的。这都是课外的安排，正经专业的课程我学的不好也不差，主要是兴趣不是太大。</p>
<p><img src="http://image.135editor.com/files/users/253/2537090/201707/DuCUGpCX_xKuc.jpg" alt=""></p>
<p>后来也就是大二快大三的时候，我无意中接触到编程，就是在网上看黑客的教程什么的，然后慢慢开始研究，不得不说兴趣果然是最大的驱动力，那时候去图书馆借阅了好多编程的书，对着书敲代码，书上的例子一般没几个能立马运行的，然后还得自己调试，但运行成功的那一刻成就感慢慢的，然后撸码就成了我业余活动之一，想想宿舍里四个人，三个游戏打的热火朝天，一个人在那默默敲代码，当然我也不是自夸什么的，那时候也没想那么多，就是做自己喜欢的事呗，我也没有瞧不起别人什么的，与室友们关系也挺铁的，大家经常一起喝喝酒，吹吹牛逼什么的，不过在我的影响下，有好几个同学也入坑了，这里的经历就说来话长了，有机会再说。</p>
<p>可以说我是运气，但归根结底还是因为我有所准备，毕业之前就能找到报酬很可观的工作。</p>
<p>这里有两个道理我想分享给大家。机会往往垂青有所准备的人；很多时候我们只要咬牙坚持下来就可以打败所有的对手。</p>
<p>写着写着就啰嗦了，未完待续。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/16/仿360市场下载按钮/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="子质">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="子质’s Notes">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="子质’s Notes" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/16/仿360市场下载按钮/" itemprop="url">
                  仿360市场下载按钮
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-16T10:40:11+08:00">
                2017-05-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/05/16/仿360市场下载按钮/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/05/16/仿360市场下载按钮/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2017/05/16/仿360市场下载按钮/" class="leancloud_visitors" data-flag-title="仿360市场下载按钮">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>先看一下效果：<br><img src="http://ohe81rx2w.bkt.clouddn.com/360downloadView.gif" alt=""></p>
<p>无论多复杂的动画我们都是可以分割成小单元的，然后分步来实现。这个动画大概分为收缩，准备，加载，完成几个部分。为此定义一个枚举类来描述view的状态。<br><code>public enum Status {
        NORMAL, START, PRE, EXPAND, LOAD, END
    }</code></p>
<h3 id="收缩动画"><a href="#收缩动画" class="headerlink" title="收缩动画"></a>收缩动画</h3><p>使用动画不断改变圆角矩形的宽度，触发重绘。代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">private void initAnim() &#123;</div><div class="line">        Animation animation1 = new Animation() &#123;</div><div class="line">            @Override</div><div class="line">            protected void applyTransformation(float interpolatedTime, Transformation t) &#123;</div><div class="line">                mCurrLength = mWidth * (1 - interpolatedTime);</div><div class="line">                if (mCurrLength &lt; mHeight) &#123;</div><div class="line">                    mCurrLength = mHeight;</div><div class="line">                    clearAnimation();</div><div class="line">                    mAngleAnim.start();</div><div class="line">                &#125;</div><div class="line">                invalidate();</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        animation1.setDuration(mShrinkDuration);</div><div class="line">        animation1.setInterpolator(new LinearInterpolator());</div><div class="line">        animation1.setAnimationListener(new Animation.AnimationListener() &#123;</div><div class="line">            @Override</div><div class="line">            public void onAnimationStart(Animation animation) &#123;</div><div class="line">                mStatus = Status.START;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            @Override</div><div class="line">            public void onAnimationEnd(Animation animation) &#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            @Override</div><div class="line">            public void onAnimationRepeat(Animation animation) &#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        mShrinkAnim = animation1;</div><div class="line">		...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>onDraw中绘制：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">if (mStatus == Status.START || mStatus == Status.NORMAL) &#123;</div><div class="line">    float left = (mWidth - mCurrLength) / 2f;</div><div class="line">    float right = (mWidth + mCurrLength) / 2f;</div><div class="line">    float r = mHeight / 2f;</div><div class="line">    canvas.drawRoundRect(new RectF(left, 0, right, mHeight), r, r, mBgPaint);</div><div class="line">    if (mStatus == Status.NORMAL) &#123;</div><div class="line">        Paint.FontMetrics fm = mTextPaint.getFontMetrics();</div><div class="line">        float y = mHeight / 2 + (fm.descent - fm.ascent) / 2 - fm.descent;</div><div class="line">        canvas.drawText(&quot;下载&quot;, mWidth / 2, y, mTextPaint);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="准备动画"><a href="#准备动画" class="headerlink" title="准备动画"></a>准备动画</h3><p>此时旋转动画，是通过canvas绘制背景圆和三个小圆，然后不断旋转画布来实现的，具体求圆心坐标和角度动画我们直接看代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">ValueAnimator animator = ValueAnimator.ofFloat(0, 1);</div><div class="line">       animator.addUpdateListener(new ValueAnimator.AnimatorUpdateListener() &#123;</div><div class="line">           @Override</div><div class="line">           public void onAnimationUpdate(ValueAnimator animation) &#123;</div><div class="line">               mAngle += mPreAnimSpeed;</div><div class="line">               invalidate();</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">       animator.addListener(new Animator.AnimatorListener() &#123;</div><div class="line">           @Override</div><div class="line">           public void onAnimationStart(Animator animation) &#123;</div><div class="line">               mStatus = Status.PRE;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           @Override</div><div class="line">           public void onAnimationEnd(Animator animation) &#123;</div><div class="line">               mAngleAnim.cancel();</div><div class="line">               startAnimation(mTranslateAnim);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           @Override</div><div class="line">           public void onAnimationCancel(Animator animation) &#123;</div><div class="line"></div><div class="line">           &#125;</div><div class="line"></div><div class="line">           @Override</div><div class="line">           public void onAnimationRepeat(Animator animation) &#123;</div><div class="line"></div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line"></div><div class="line">       animator.setDuration(mPreAnimDuration);</div><div class="line">       animator.setInterpolator(new LinearInterpolator());</div><div class="line">       mAngleAnim = animator;</div></pre></td></tr></table></figure></p>
<p>onDraw中绘制代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">if (mStatus == Status.PRE) &#123;</div><div class="line">          canvas.drawCircle(mWidth / 2f, mHeight / 2f, mHeight / 2f, mBgPaint);</div><div class="line">          canvas.save();</div><div class="line">          mTextPaint.setStyle(Paint.Style.FILL);</div><div class="line">          canvas.rotate(mAngle, mWidth / 2, mHeight / 2);</div><div class="line">          //大圆的圆心 半径</div><div class="line">          float cX = mWidth / 2f;</div><div class="line">          float cY = mHeight / 2f;</div><div class="line">          float radius = mHeight / 2 / 3f;</div><div class="line">          canvas.drawCircle(cX, cY, radius, mTextPaint);</div><div class="line">          //上方小圆的参数</div><div class="line">          float rr = radius / 2f;</div><div class="line">          float cYY = mHeight / 2 - (radius + rr / 3);</div><div class="line">          canvas.drawCircle(cX, cYY, rr, mTextPaint);</div><div class="line">          //左下小圆参数</div><div class="line">          float cXX = (float) (cX - Math.sqrt(2) / 2f * (radius + rr / 3f));</div><div class="line">          cYY = (float) (mHeight / 2 + Math.sqrt(2) / 2f * (radius + rr / 3f));</div><div class="line">          canvas.drawCircle(cXX, cYY, rr, mTextPaint);</div><div class="line">          //右下小圆参数</div><div class="line">          cXX = (float) (cX + Math.sqrt(2) / 2f * (radius + rr / 3f));</div><div class="line">          canvas.drawCircle(cXX, cYY, rr, mTextPaint);</div><div class="line">          canvas.restore();</div><div class="line">      &#125;</div></pre></td></tr></table></figure></p>
<h3 id="展开动画"><a href="#展开动画" class="headerlink" title="展开动画"></a>展开动画</h3><p>展开动画也是不断改变view的宽度并重绘圆角矩形，同时需要对准备动画的状态进行向右位移。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">Animation animator1 = new Animation() &#123;</div><div class="line">           @Override</div><div class="line">           protected void applyTransformation(float interpolatedTime, Transformation t) &#123;</div><div class="line">               mCurrLength = mHeight + (mWidth - mHeight) * interpolatedTime;</div><div class="line">               mTranslationX = (mWidth - mHeight) / 2 * interpolatedTime;</div><div class="line">               invalidate();</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line">       animator1.setAnimationListener(new Animation.AnimationListener() &#123;</div><div class="line">           @Override</div><div class="line">           public void onAnimationStart(Animation animation) &#123;</div><div class="line">               mStatus = Status.EXPAND;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           @Override</div><div class="line">           public void onAnimationEnd(Animation animation) &#123;</div><div class="line">               clearAnimation();</div><div class="line">               mLoadAngleAnim.start();</div><div class="line">               mMovePointAnim.start();</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           @Override</div><div class="line">           public void onAnimationRepeat(Animation animation) &#123;</div><div class="line"></div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">       animator1.setDuration(mExpandAnimDuration);</div><div class="line">       animator1.setInterpolator(new LinearInterpolator());</div><div class="line">       mTranslateAnim = animator1;</div></pre></td></tr></table></figure></p>
<p>onDraw中绘制代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">if (mStatus == Status.EXPAND) &#123;</div><div class="line">          float left = (mWidth - mCurrLength) / 2f;</div><div class="line">          float right = (mWidth + mCurrLength) / 2f;</div><div class="line">          float r = mHeight / 2f;</div><div class="line">          canvas.drawRoundRect(new RectF(left, 0, right, mHeight), r, r, mBgPaint);</div><div class="line">          canvas.save();</div><div class="line">          mTextPaint.setStyle(Paint.Style.FILL);</div><div class="line">          canvas.translate(mTranslationX, 0);</div><div class="line">          //大圆的圆心 半径</div><div class="line">          float cX = mWidth / 2f;</div><div class="line">          float cY = mHeight / 2f;</div><div class="line">          float radius = mHeight / 2 / 3f;</div><div class="line">          canvas.drawCircle(cX, cY, radius, mTextPaint);</div><div class="line">          //上方小圆的参数</div><div class="line">          float rr = radius / 2f;</div><div class="line">          float cYY = mHeight / 2 - (radius + rr / 3);</div><div class="line">          canvas.drawCircle(cX, cYY, rr, mTextPaint);</div><div class="line">          //左下小圆参数</div><div class="line">          float cXX = (float) (cX - Math.sqrt(2) / 2f * (radius + rr / 3f));</div><div class="line">          cYY = (float) (mHeight / 2 + Math.sqrt(2) / 2f * (radius + rr / 3f));</div><div class="line">          canvas.drawCircle(cXX, cYY, rr, mTextPaint);</div><div class="line">          //右下小圆参数</div><div class="line">          cXX = (float) (cX + Math.sqrt(2) / 2f * (radius + rr / 3f));</div><div class="line">          canvas.drawCircle(cXX, cYY, rr, mTextPaint);</div><div class="line">          canvas.restore();</div><div class="line">      &#125;</div></pre></td></tr></table></figure></p>
<h3 id="加载动画"><a href="#加载动画" class="headerlink" title="加载动画"></a>加载动画</h3><p>加载动画分三部分，右侧的旋转动画，正弦轨迹运动的小球动画，进度更新的动画。正弦动画要求出正弦函数的周期，y轴偏移量，x轴偏移量。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">ValueAnimator animator2 = ValueAnimator.ofFloat(0, 1);</div><div class="line">       animator2.addUpdateListener(new ValueAnimator.AnimatorUpdateListener() &#123;</div><div class="line">           @Override</div><div class="line">           public void onAnimationUpdate(ValueAnimator animation) &#123;</div><div class="line">               mLoadAngle += mLoadRotateAnimSpeed;</div><div class="line">               invalidate();</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">       animator2.addListener(new Animator.AnimatorListener() &#123;</div><div class="line">           @Override</div><div class="line">           public void onAnimationStart(Animator animation) &#123;</div><div class="line">               mStatus = Status.LOAD;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           @Override</div><div class="line">           public void onAnimationEnd(Animator animation) &#123;</div><div class="line">               mLoadAngleAnim.cancel();</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           @Override</div><div class="line">           public void onAnimationCancel(Animator animation) &#123;</div><div class="line"></div><div class="line">           &#125;</div><div class="line"></div><div class="line">           @Override</div><div class="line">           public void onAnimationRepeat(Animator animation) &#123;</div><div class="line"></div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">       animator2.setDuration(Integer.MAX_VALUE);</div><div class="line">       animator2.setInterpolator(new LinearInterpolator());</div><div class="line">       mLoadAngleAnim = animator2;</div></pre></td></tr></table></figure></p>
<p>onDraw中绘制代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">if (mStatus == Status.LOAD || mStatus == Status.END) &#123;</div><div class="line">           float left = (mWidth - mCurrLength) / 2f;</div><div class="line">           float right = (mWidth + mCurrLength) / 2f;</div><div class="line">           float r = mHeight / 2f;</div><div class="line">           mBgPaint.setColor(mProgressColor);</div><div class="line">           canvas.drawRoundRect(new RectF(left, 0, right, mHeight), r, r, mBgPaint);</div><div class="line">           if (mProgress != 100) &#123;</div><div class="line">               for (int i = 0; i &lt; mFourMovePoints.length; i++) &#123;</div><div class="line">                   if (mFourMovePoints[i].isDraw)</div><div class="line">                       canvas.drawCircle(mFourMovePoints[i].moveX, mFourMovePoints[i].moveY, mFourMovePoints[i].radius, mTextPaint);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           float progressRight = mProgress * mWidth / 100f;</div><div class="line">           mBgPaint.setColor(mBgColor);</div><div class="line">           canvas.save();</div><div class="line">           canvas.clipRect(0, 0, progressRight, mHeight);</div><div class="line">           canvas.drawRoundRect(new RectF(left, 0, right, mHeight), r, r, mBgPaint);</div><div class="line">           canvas.restore();</div><div class="line"></div><div class="line">           if (mProgress != 100) &#123;</div><div class="line">               canvas.drawCircle(mWidth - mHeight / 2, mHeight / 2, mHeight / 2, mBgPaint);</div><div class="line">               canvas.save();</div><div class="line">               mTextPaint.setStyle(Paint.Style.FILL);</div><div class="line">               canvas.rotate(mLoadAngle, mWidth - mHeight / 2, mHeight / 2);</div><div class="line">               canvas.drawCircle(mWidth - mHeight + 30, getCenterY(mWidth - mHeight + 30, 5), 5, mTextPaint);</div><div class="line">               canvas.drawCircle(mWidth - mHeight + 45, getCenterY(mWidth - mHeight + 45, 8), 8, mTextPaint);</div><div class="line">               canvas.drawCircle(mWidth - mHeight + 68, getCenterY(mWidth - mHeight + 68, 11), 11, mTextPaint);</div><div class="line">               canvas.drawCircle(mWidth - mHeight + 98, getCenterY(mWidth - mHeight + 98, 14), 14, mTextPaint);</div><div class="line">               canvas.restore();</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           Paint.FontMetrics fm = mTextPaint.getFontMetrics();</div><div class="line">           float y = mHeight / 2 + (fm.descent - fm.ascent) / 2 - fm.descent;</div><div class="line">           canvas.drawText(mProgress + &quot;%&quot;, mWidth / 2, y, mTextPaint);</div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>
<p>完整代码见<a href="https://github.com/Metal626/360DownLoadView" target="_blank" rel="external">GitHub</a>。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/12/Retrofit+Rxjava服务器IP轮询重试机制实现/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="子质">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="子质’s Notes">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="子质’s Notes" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/12/Retrofit+Rxjava服务器IP轮询重试机制实现/" itemprop="url">
                  Retrofit+Rxjava服务器IP轮询重试机制实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-12T15:44:48+08:00">
                2016-12-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/12/Retrofit+Rxjava服务器IP轮询重试机制实现/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/12/Retrofit+Rxjava服务器IP轮询重试机制实现/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/12/12/Retrofit+Rxjava服务器IP轮询重试机制实现/" class="leancloud_visitors" data-flag-title="Retrofit+Rxjava服务器IP轮询重试机制实现">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>为了保证客户端稳定性和网络容错性，提升用户体验，在客户端建立服务端IP轮询及重试机制是十分有必要的，本文为我个人经验总结，希望对你能有参考价值。</p>
</blockquote>
<p>app在启动时会请求一些配置信息，其中就包括ip的路由表，将这份路由表存储到本地，至于是sp还是对象持久化抑或是其他方式，可根据实际情况自行选择。</p>
<p>因为项目网络层由Retrofit+Rxjava+Okhttp实现，Retrofit运行时无法改变baseUrl,即使可以通过反射的方式来改变baseUrl，也无法对已经生成的service对象起作用，而且我的项目中所有service对象都通过Dagger2注入，所以最终使用了这样一种方式。</p>
<p>url交给UrlManager来管理<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UrlManager</span> </span>&#123;</div><div class="line">   </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] HOST_SITE = &#123;<span class="string">"https://xxx/api/"</span>,xxx&#125;;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] HOST_WEB = &#123;<span class="string">"https://xxx/"</span>,xxx&#125;;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HOST_SITE_DEBUG = <span class="string">"https://xxx/api/"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HOST_WEB_DEBUG = <span class="string">"https://xxx/"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; list;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Random random = <span class="keyword">new</span> Random();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getHostSite</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (BuildConfig.IS_DEBUG) &#123;</div><div class="line">            <span class="keyword">return</span> processUrl(HOST_SITE_DEBUG);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            String host = getDynamicHost();</div><div class="line">            <span class="keyword">if</span> (!TextUtils.isEmpty(host)) <span class="keyword">return</span> host;</div><div class="line">            <span class="keyword">return</span> HOST_SITE[random.nextInt(HOST_SITE.length)];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getDynamicHost</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> index = (<span class="keyword">int</span>) SPUtils.get(NeutronApplication.getContext(), Constants.URL, <span class="number">0</span>);</div><div class="line">        <span class="keyword">if</span> (list != <span class="keyword">null</span> &amp;&amp; list.size() &gt; <span class="number">0</span> &amp;&amp; index &lt; list.size())</div><div class="line">            <span class="keyword">return</span> list.get(index);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getHostWeb</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (BuildConfig.IS_DEBUG) &#123;</div><div class="line">            <span class="keyword">return</span> processUrl(HOST_WEB_DEBUG);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            String host = getDynamicHost();</div><div class="line">            <span class="keyword">if</span> (!TextUtils.isEmpty(host)) <span class="keyword">return</span> host;</div><div class="line">            <span class="keyword">return</span> HOST_WEB[random.nextInt(HOST_WEB.length)];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setHosts</span><span class="params">(List&lt;String&gt; list)</span> </span>&#123;</div><div class="line">        UrlManager.list = list;</div><div class="line">        RxHelper.setCounterAttempts(list.size());</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">updateUrlIndex</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (list != <span class="keyword">null</span> &amp;&amp; i &gt;= list.size())</div><div class="line">            i = <span class="number">0</span>;</div><div class="line">        SPUtils.put(NeutronApplication.getContext(), Constants.URL, i);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">updateUrlIndex</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> o = (<span class="keyword">int</span>) SPUtils.get(NeutronApplication.getContext(), Constants.URL, <span class="number">0</span>);</div><div class="line">        updateUrlIndex(o + <span class="number">1</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>app启动时拉取到配置后设置UrlManager中的路由表，然后每次根据索引去路由表动态拿请求地址，那路由索引由谁来控制呢？<br>因为我将项目中的rxjava抽取了一层RxHelper,所以这件事就交给RxHelper来干了，可以覆盖所有的网络请求。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RxHelper</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COUNTER_START = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> COUNTER_ATTEMPTS = <span class="number">3</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setCounterAttempts</span><span class="params">(<span class="keyword">int</span> counterAttempts)</span> </span>&#123;</div><div class="line">        COUNTER_ATTEMPTS = counterAttempts;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; rx.Observable.<span class="function">Transformer&lt;T, T&gt; <span class="title">handleResult</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> tObservable -&gt; tObservable</div><div class="line">                .flatMap(RxHelper::createData)</div><div class="line">                .retryWhen(observable -&gt; observable.compose(zipWithFlatMap()))</div><div class="line">                .observeOn(AndroidSchedulers.mainThread())</div><div class="line">                .subscribeOn(Schedulers.io());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; rx.Observable.<span class="function">Transformer&lt;T, T&gt; <span class="title">handleResultWithOutRetryPolicy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> tObservable -&gt; tObservable.flatMap(RxHelper::createData)</div><div class="line">                .observeOn(AndroidSchedulers.mainThread())</div><div class="line">                .subscribeOn(Schedulers.io());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Observable.<span class="function">Transformer&lt;T, Long&gt; <span class="title">zipWithFlatMap</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> observable -&gt;</div><div class="line">                observable.zipWith(Observable.range(COUNTER_START, COUNTER_ATTEMPTS),</div><div class="line">                        (t, repeatAttempt) -&gt; repeatAttempt)</div><div class="line">                        .flatMap(<span class="keyword">new</span> Func1&lt;Integer, Observable&lt;Long&gt;&gt;() &#123;</div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> Observable&lt;Long&gt; <span class="title">call</span><span class="params">(Integer repeatAttempt)</span> </span>&#123;</div><div class="line">                                UrlManager.updateUrlIndex(repeatAttempt);</div><div class="line">                                <span class="keyword">return</span> Observable.timer(repeatAttempt * <span class="number">200</span>, TimeUnit.MILLISECONDS);</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">createData</span><span class="params">(<span class="keyword">final</span> T t)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;T&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> T&gt; subscriber)</span> </span>&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    subscriber.onNext(t);</div><div class="line">                    subscriber.onCompleted();</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    LogUtils.logw(<span class="string">"Rxhelper: "</span> + e.toString());</div><div class="line">                    subscriber.onError(e);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样在每次请求错误时，会递增路由表索引，继续下次请求，轮询的间隔为<code>Observable.timer(repeatAttempt * 200, TimeUnit.MILLISECONDS);</code><br>对RxJava的retryWhen不理解的同学请移步<a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0206/3953.html" target="_blank" rel="external">对RxJava中.repeatWhen()和.retryWhen()操作符的思考</a>。</p>
<p>之前也说了，retrofit不能修改baseUrl，反射的方式也不适合我的项目，至于利用builder生成新的retrofit对象的方式更不考虑了，那我是怎么实现运行时修改请求地址的呢？别忘了okhttp是可以添加拦截器的，在OkHttpIntercepter中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OkHttpInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="comment">//配置request</span></div><div class="line">        Request request = chain.request();</div><div class="line">        Request.Builder requestBuilder = request.newBuilder();</div><div class="line">        String url = UrlManager.getHostSite();</div><div class="line">        Uri parse = Uri.parse(url);</div><div class="line">        String host = parse.getHost();</div><div class="line">        HttpUrl httpUrl = request.url().newBuilder().host(host).build();</div><div class="line">        requestBuilder.url(httpUrl);</div><div class="line">        Response.Builder responseBuilder = chain.proceed(requestBuilder.build()).newBuilder();</div><div class="line">        Response response = responseBuilder.build();</div><div class="line">        <span class="keyword">return</span> response;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>拦截请求的url,修改其host，这样整个流程就ok了，http的各种错误码的处理也是可以在拦截器中统一处理的，至于其他健壮性的考虑此处就不做过多阐述了。</p>
<p>有同学问我，如果想处理最后一次error通知怎么办呢？可以这样做，修改过的RxHelper如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RxHelper</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COUNTER_START = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> COUNTER_ATTEMPTS = <span class="number">3</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setCounterAttempts</span><span class="params">(<span class="keyword">int</span> counterAttempts)</span> </span>&#123;</div><div class="line">        COUNTER_ATTEMPTS = counterAttempts;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; rx.Observable.<span class="function">Transformer&lt;T, T&gt; <span class="title">handleResult</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> tObservable -&gt; tObservable</div><div class="line">                .flatMap(RxHelper::createData)</div><div class="line">                .retryWhen(error -&gt; delayedRetry(error))</div><div class="line">                .observeOn(AndroidSchedulers.mainThread())</div><div class="line">                .subscribeOn(Schedulers.io());</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//猫腻主要在这个方法</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Observable&lt;Object&gt; <span class="title">delayedRetry</span><span class="params">(Observable&lt;? extends Throwable&gt; error)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> error.zipWith(Observable.range(COUNTER_START, COUNTER_ATTEMPTS + <span class="number">1</span>),</div><div class="line">                (i, repeatAttempt) -&gt; repeatAttempt)</div><div class="line">                .flatMap(o -&gt; &#123;</div><div class="line">                    UrlManager.updateUrlIndex(o);</div><div class="line">                    LogUtils.logw(<span class="string">"repeat: "</span> + o);</div><div class="line">                    <span class="keyword">return</span> o &lt; COUNTER_ATTEMPTS ? Observable.timer(o * <span class="number">200</span>, TimeUnit.MILLISECONDS)</div><div class="line">                            : error.flatMap(Observable::error);</div><div class="line">                &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; rx.Observable.<span class="function">Transformer&lt;T, T&gt; <span class="title">handleResultWithOutRetryPolicy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> tObservable -&gt; tObservable.flatMap(RxHelper::createData)</div><div class="line">                .observeOn(AndroidSchedulers.mainThread())</div><div class="line">                .subscribeOn(Schedulers.io());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">createData</span><span class="params">(<span class="keyword">final</span> T t)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;T&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> T&gt; subscriber)</span> </span>&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    subscriber.onNext(t);</div><div class="line">                    subscriber.onCompleted();</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    subscriber.onError(e);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/12/android多渠道打包/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="子质">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="子质’s Notes">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="子质’s Notes" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/12/android多渠道打包/" itemprop="url">
                  android多渠道打包最快方案
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-12T15:04:02+08:00">
                2016-12-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/12/android多渠道打包/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/12/android多渠道打包/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/12/12/android多渠道打包/" class="leancloud_visitors" data-flag-title="android多渠道打包最快方案">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>目前Android多渠道打包主要两种方式：</p>
<h4 id="Gradle方式。"><a href="#Gradle方式。" class="headerlink" title="Gradle方式。"></a>Gradle方式。</h4><p>   在build.gradle配置:<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">productFlavors &#123;</div><div class="line">       huawei &#123;</div><div class="line">           manifestPlaceholders = [UMENG_CHANNEL_VALUE: <span class="string">"huawei"</span>]</div><div class="line">       &#125;</div><div class="line">       xiaomi &#123;</div><div class="line">           manifestPlaceholders = [UMENG_CHANNEL_VALUE: <span class="string">"xiaomi"</span>]</div><div class="line">       &#125;</div><div class="line">       ...</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>渠道多的时候会导致gradle文件很长，如果想简化书写可以这样做：<br>在build.gradle中配置如下：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Properties properties = <span class="keyword">new</span> Properties()</div><div class="line">properties.load(<span class="keyword">project</span>.rootProject.<span class="keyword">file</span>(<span class="string">'local.properties'</span>).newDataInputStream())</div><div class="line">...</div><div class="line">android&#123;</div><div class="line">    ...</div><div class="line">    productFlavors &#123;</div><div class="line">            <span class="keyword">def</span> channelArray = properties.getProperty(<span class="string">"channel"</span>).split(<span class="string">";"</span>);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; channelArray.<span class="keyword">size</span>(); i++) &#123;</div><div class="line">                <span class="keyword">def</span> channel = channelArray[i]</div><div class="line">                <span class="string">"$&#123;channel&#125;"</span> &#123;</div><div class="line">                    manifestPlaceholders = [CHANNEL_VALUE: channel]</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>local.properties中添加所有渠道号：<code>channel=wandoujia;_360;yingyongbao;xiaomi;baidu;huawei;...</code></p>
<p>当渠道很多的时候，每次打包的时间要几十分钟到几个小时，那么有没有更快速的方式呢，请看第二种方式。</p>
<h4 id="META-INF方式。"><a href="#META-INF方式。" class="headerlink" title="META-INF方式。"></a>META-INF方式。</h4><p>使用此种方式可以动态获取当前渠道号，极大节省了打包时间。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 友盟配置</div><div class="line"> 在application onCreate方法调用</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">umengConfig</span><span class="params">()</span> </span>&#123;</div><div class="line">    String channel = getChannelFromApk(application, <span class="string">"channel-"</span>);</div><div class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(channel)) &#123;</div><div class="line">        channel = <span class="string">"default"</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (BuildConfig.IS_DEBUG) &#123;</div><div class="line">        Toast.makeText(application, <span class="string">"当前渠道:"</span> + channel, Toast.LENGTH_SHORT).show();</div><div class="line">    &#125;</div><div class="line">    AnalyticsConfig.setChannel(channel);</div><div class="line">&#125;</div><div class="line"></div><div class="line"> <span class="comment">/**</span></div><div class="line"> * 从apk中获取版本信息</div><div class="line"> * <span class="doctag">@param</span> context</div><div class="line"> * <span class="doctag">@param</span> channelPrefix 渠道前缀</div><div class="line"> * <span class="doctag">@return</span></div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getChannelFromApk</span><span class="params">(Context context, String channelPrefix)</span> </span>&#123;</div><div class="line">    <span class="comment">//从apk包中获取</span></div><div class="line">    ApplicationInfo appinfo = context.getApplicationInfo();</div><div class="line">    String sourceDir = appinfo.sourceDir;</div><div class="line">    <span class="comment">//默认放在meta-inf/里， 所以需要再拼接一下</span></div><div class="line">    String key = <span class="string">"META-INF/"</span> + channelPrefix;</div><div class="line">    String ret = <span class="string">""</span>;</div><div class="line">    ZipFile zipfile = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        zipfile = <span class="keyword">new</span> ZipFile(sourceDir);</div><div class="line">        Enumeration&lt;?&gt; entries = zipfile.entries();</div><div class="line">        <span class="keyword">while</span> (entries.hasMoreElements()) &#123;</div><div class="line">            ZipEntry entry = ((ZipEntry) entries.nextElement());</div><div class="line">            String entryName = entry.getName();</div><div class="line">            <span class="keyword">if</span> (entryName.startsWith(key)) &#123;</div><div class="line">                ret = entryName;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="keyword">if</span> (zipfile != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                zipfile.close();</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    String[] split = ret.split(channelPrefix);</div><div class="line">    String channel = <span class="string">""</span>;</div><div class="line">    <span class="keyword">if</span> (split != <span class="keyword">null</span> &amp;&amp; split.length &gt;= <span class="number">2</span>) &#123;</div><div class="line">        channel = ret.substring(key.length());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> channel;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>每次动态获取应用包下meta-inf文件夹中的渠道文件取得渠道号，那么meta-inf下的渠道文件如何添加呢?我们可以使用python脚本来做这件事。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="comment"># coding=utf-8</span></div><div class="line"><span class="keyword">import</span> zipfile</div><div class="line"><span class="keyword">import</span> shutil</div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> ConfigParser</div><div class="line"></div><div class="line"><span class="comment">#读取配置文件</span></div><div class="line">config = ConfigParser.ConfigParser()</div><div class="line">config.read(<span class="string">"channels-config.ini"</span>)</div><div class="line"><span class="comment">#apk路径</span></div><div class="line">apk_path = config.get(<span class="string">"Build-Config"</span>, <span class="string">"apk.path"</span>)</div><div class="line"><span class="keyword">print</span> <span class="string">"src apk path="</span> + apk_path</div><div class="line"><span class="comment">#渠道识别前缀</span></div><div class="line">channel_prefix = config.get(<span class="string">"Build-Config"</span>, <span class="string">"channel.prefix"</span>)</div><div class="line"><span class="keyword">print</span> <span class="string">"channel prefix="</span> + channel_prefix</div><div class="line"><span class="comment">#渠道列表</span></div><div class="line">channel_list = config.get(<span class="string">"Build-Config"</span>, <span class="string">"channel.list"</span>)</div><div class="line"><span class="keyword">print</span> <span class="string">"channel list="</span> + channel_list</div><div class="line"><span class="comment">#解析渠道，生成渠道数组</span></div><div class="line">channel_array = channel_list.split(<span class="string">','</span>)</div><div class="line"></div><div class="line"><span class="comment"># 空文件 便于写入此空文件到apk包中作为channel文件</span></div><div class="line">src_temp_file = <span class="string">'temp_.txt'</span></div><div class="line"><span class="comment"># 创建一个空文件（不存在则创建）</span></div><div class="line">f = open(src_temp_file, <span class="string">'w'</span>)</div><div class="line">f.close()</div><div class="line"></div><div class="line"></div><div class="line">src_apk = apk_path</div><div class="line"><span class="comment"># file name (with extension)</span></div><div class="line">src_apk_file_name = os.path.basename(src_apk)</div><div class="line"><span class="comment"># 分割文件名与后缀</span></div><div class="line">temp_list = os.path.splitext(src_apk_file_name)</div><div class="line"><span class="comment"># name without extension</span></div><div class="line">src_apk_name = temp_list[<span class="number">0</span>]</div><div class="line"><span class="comment"># 后缀名，包含.   例如: ".apk "</span></div><div class="line">src_apk_extension = temp_list[<span class="number">1</span>]</div><div class="line"></div><div class="line"><span class="comment"># 创建生成目录,与文件名相关</span></div><div class="line">output_dir = <span class="string">'apks_'</span> + src_apk_name + <span class="string">'/'</span></div><div class="line"><span class="comment"># 目录不存在则创建</span></div><div class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(output_dir):</div><div class="line">    os.mkdir(output_dir)</div><div class="line"></div><div class="line"><span class="comment"># 遍历渠道号并创建对应渠道号的apk文件</span></div><div class="line"><span class="keyword">for</span> line <span class="keyword">in</span> channel_array:</div><div class="line">    <span class="comment"># 获取当前渠道号，因为从渠道文件中获得带有\n,所有strip一下</span></div><div class="line">    target_channel = line.strip()</div><div class="line">    <span class="comment"># 拼接对应渠道号的apk</span></div><div class="line">    target_apk = output_dir + src_apk_name + <span class="string">"-"</span> + target_channel + src_apk_extension</div><div class="line">    <span class="comment"># 拷贝建立新apk</span></div><div class="line">    shutil.copy(src_apk,  target_apk)</div><div class="line">    <span class="comment"># zip获取新建立的apk文件</span></div><div class="line">    zipped = zipfile.ZipFile(target_apk, <span class="string">'a'</span>, zipfile.ZIP_DEFLATED)</div><div class="line"></div><div class="line">    <span class="comment"># 初始化渠道信息</span></div><div class="line">    target_channel_file = <span class="string">"META-INF/"</span> + channel_prefix + <span class="string">"&#123;channel&#125;"</span>.format(channel = target_channel)</div><div class="line">    <span class="comment"># 写入渠道信息</span></div><div class="line">    zipped.write(src_temp_file, target_channel_file)</div><div class="line">    <span class="comment"># 关闭zip流</span></div><div class="line">    zipped.close()</div><div class="line"></div><div class="line"><span class="comment">#删除临时文件</span></div><div class="line">os.remove(src_temp_file)</div></pre></td></tr></table></figure></p>
<p>channels-config.ini文件如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[Build-Config]</div><div class="line">apk.path = your apk path</div><div class="line">channel.prefix = channel-</div><div class="line">channel.list = baidu,xiaomi</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/12/jenkins+gitlab+蒲公英实现android应用自动化打包分发/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="子质">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="子质’s Notes">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="子质’s Notes" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/12/jenkins+gitlab+蒲公英实现android应用自动化打包分发/" itemprop="url">
                  jenkins+gitlab+蒲公英实现android应用自动化打包分发
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-12T11:26:51+08:00">
                2016-12-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/12/jenkins+gitlab+蒲公英实现android应用自动化打包分发/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/12/jenkins+gitlab+蒲公英实现android应用自动化打包分发/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/12/12/jenkins+gitlab+蒲公英实现android应用自动化打包分发/" class="leancloud_visitors" data-flag-title="jenkins+gitlab+蒲公英实现android应用自动化打包分发">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>作为一名高效的开发者，要尽量避免的重复劳动实现自动化的流程。搭建本地jenkins服务器，实现自动化打包流程，从此测试包交给测试人员自己去打就好了，集成蒲公英等分发平台，实现二维码或短链接下载，也为运营人员提供了便捷。</p>
</blockquote>
<h3 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h3><p>前往<a href="https://jenkins.io/" target="_blank" rel="external">https://jenkins.io/</a>下载对应系统版本的jenkins包，本文以windows为例，两种方式：</p>
<ol>
<li>下载windows对应的安装包，安装后jenkins作为windows服务占用本地8080端口;在浏览器输入<code>localhost:8080</code>即可访问。</li>
<li>下载tomcat服务器，然后下载jenkins war包，将其部署到tomcat webapps 目录下,启动tomcat后，在浏览器使用<code>localhost:8080/jenkins</code>访问。</li>
</ol>
<p>启动后，会看到jenkins初始配置页面，这里需要选择安装的插件，例如：我要集成gitlab，所以选择gitlab的插件，如果你是集成github，则选择github插件，大体流程相同，插件可以后期根据需要再安装。</p>
<p><img src="http://ohe81rx2w.bkt.clouddn.com/16-12-12/80636207-file_1481523650297_1148a.png" alt=""></p>
<p>进入主页后，点击系统管理-&gt;Global Tool Configuration，设置jdk、git及gradle等。</p>
<h3 id="配置参数"><a href="#配置参数" class="headerlink" title="配置参数"></a>配置参数</h3><p>新建自由风格的软件项目</p>
<p><img src="http://ohe81rx2w.bkt.clouddn.com/16-12-12/13268849-file_1481515797721_8498.png" alt=""></p>
<p>进入配置页面</p>
<p><img src="http://ohe81rx2w.bkt.clouddn.com/16-12-12/49682489-file_1481516027421_13068.png" alt=""></p>
<p>配置Gernal模块。选中参数化构建过程选项，配置如下：</p>
<p><img src="http://ohe81rx2w.bkt.clouddn.com/16-12-12/50399692-file_1481516484754_87d.png" alt=""></p>
<p>配置源码管理。设置远程仓库的地址，http方式和ssh方式都是支持的。</p>
<p><img src="http://ohe81rx2w.bkt.clouddn.com/16-12-12/31227347-file_1481516862467_9231.png" alt=""><br><strong>ps:</strong>如果没有git选项，可能git环境设置不成功，请去首页-系统管理-Global Tool Configuration页，设置jdk、git及gradle等。</p>
<p>构建触发器。这里有两个选项：</p>
<ol>
<li><p>Poll SCM：定时检查源码变更（根据SCM软件的版本号），如果有更新就checkout最新code下来，然后执行构建动作。我的配置如下：<br><em>/5 </em> <em> </em> *  （每5分钟检查一次源码变化）</p>
</li>
<li><p>Build periodically：周期进行项目构建（它不care源码是否发生变化），我的配置如下：<br>0 2 <em> </em> *  （每天2:00 必须build一次源码）<br>这里只是向大家说明，本案例因为android每次按照版本及渠道发包，所以不做配置。</p>
</li>
</ol>
<p>构建模块配置</p>
<p><img src="http://ohe81rx2w.bkt.clouddn.com/16-12-12/27064469-file_1481520970804_6f71.png" alt=""><br>选择项目所使用gradle版本，gradle任务：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-PIS_JENKINS=$&#123;IS_JENKINS&#125; -PAPP_VERSION=$&#123;APP_VERSION&#125; -PJENKINS_TIME=$&#123;JENKINS_TIME&#125;</div><div class="line">assemble$&#123;PRODUCT_FLAVOR_BUILD&#125;$&#123;ENVIRONMENT&#125;</div><div class="line">--stacktrace</div><div class="line">--debug</div><div class="line">--info</div></pre></td></tr></table></figure></p>
<p>集成到蒲公英。点击增加构建后步骤，windows选择execute Windows batch command,添加命令：<br><code>curl -k -F &quot;file=@D:\env\android-v%APP_VERSION%-%PRODUCT_FLAVOR_BUILD%-%JENKINS_TIME%-%ENVIRONMENT%.apk&quot; -F &quot;uKey=your ukey&quot; -F &quot;_api_key=your api key&quot; https://www.pgyer.com/apiv1/app/upload</code><br>这里的u key和api key是你在蒲公英平台注册开发者获得。文件的地址要跟你在项目build.gradle中配置的一样。</p>
<p>项目build.gradle配置如下：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">android&#123;</div><div class="line">...</div><div class="line">    defaultConfig &#123;</div><div class="line">    ...</div><div class="line">        versionName APP_VERSION</div><div class="line">        resValue(<span class="string">"string"</span>, <span class="string">'app_version'</span>, APP_VERSION)</div><div class="line">        manifestPlaceholders = [UMENG_CHANNEL_VALUE: <span class="string">"common"</span>]</div><div class="line">    ...    </div><div class="line">    &#125;</div><div class="line">     productFlavors &#123;</div><div class="line">        huawei &#123;</div><div class="line">            manifestPlaceholders = [UMENG_CHANNEL_VALUE: <span class="string">"huawei"</span>]</div><div class="line">        &#125;</div><div class="line">        xiaomi &#123;</div><div class="line">            manifestPlaceholders = [UMENG_CHANNEL_VALUE: <span class="string">"xiaomi"</span>]</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//修改生成的apk名字及输出目录</span></div><div class="line">     applicationVariants.all &#123; variant -&gt;</div><div class="line">        variant.outputs.<span class="keyword">each</span> &#123; output -&gt;</div><div class="line">            <span class="keyword">def</span> newName</div><div class="line">            <span class="keyword">def</span> timeNow</div><div class="line">            <span class="keyword">def</span> oldFile = output.outputFile</div><div class="line">            <span class="keyword">def</span> outDirectory = oldFile.parent</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (IS_JENKINS) &#123;</div><div class="line">                timeNow = JENKINS_TIME</div><div class="line">                outDirectory = <span class="string">'D:/env'</span></div><div class="line">                newName = <span class="string">'android-v'</span> +</div><div class="line">                        APP_VERSION + <span class="string">'-'</span> + variant.productFlavors[<span class="number">0</span>].name + <span class="string">'-'</span>+ timeNow + <span class="string">'-'</span> + variant.buildType.name + <span class="string">'.apk'</span></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                timeNow = getDate()</div><div class="line">                <span class="keyword">if</span> (variant.buildType.name.equals(<span class="string">'debug'</span>)) &#123;</div><div class="line">                    newName = <span class="string">"android-v$&#123;APP_VERSION&#125;-debug.apk"</span></div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    newName = <span class="string">'android-v'</span> +</div><div class="line">                            APP_VERSION + <span class="string">'-'</span> + variant.productFlavors[<span class="number">0</span>].name + <span class="string">'-'</span>+timeNow + <span class="string">'-'</span> + variant.buildType.name + <span class="string">'.apk'</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            output.outputFile = <span class="keyword">new</span> <span class="keyword">File</span>(outDirectory, newName)</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="开始构建任务"><a href="#开始构建任务" class="headerlink" title="开始构建任务"></a>开始构建任务</h3><p>配置完参数，保存后回到主页，点击项目后的run图标选择各项动态参数，开始任务。</p>
<p><img src="http://ohe81rx2w.bkt.clouddn.com/16-12-12/4088147-file_1481522181446_bd3c.png" alt=""></p>
<p><img src="http://ohe81rx2w.bkt.clouddn.com/16-12-12/79583275-file_1481521944640_12019.png" alt=""></p>
<p>点击构建历史中当前条目，进入Console Output，可查看此次构建任务的log信息。如果构建失败，请去查看log信息，根据错误信息纠错。</p>
<p><strong>notice:</strong> 项目gradle.properties也要添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">APP_VERSION=2.4.0</div><div class="line">IS_JENKINS=false</div><div class="line">JENKINS_TIME=&apos;&apos;</div></pre></td></tr></table></figure></p>
<p>服务器上的sdk也要跟本地保持一致。</p>
<p>jenkins最近推出了blue ocean项目，提供了更好的用户体验，具体细节在<a href="https://jenkins.io/projects/blueocean/" target="_blank" rel="external">https://jenkins.io/projects/blueocean/</a>，你也可以在可选插件里搜索BlueOcean beta,安装体验。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="子质" />
          <p class="site-author-name" itemprop="name">子质</p>
          <p class="site-description motion-element" itemprop="description">Learning is a gift , even when pain is your teacher.</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">17</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">26</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/proton626" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/6069776913/profile?topnav=1&wvr=6&is_all=1" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/victheo" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/users/ff6ebd9b5d53/latest_articles" target="_blank" title="简书">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  简书
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016-11 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">子质</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"Metal626"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  








  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("Y8y93MXpcqOE9wb5HAQs6lqf-gzGzoHsz", "YdeEwg5y5si4gx2QxCN6qjPe");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  


</body>
</html>
